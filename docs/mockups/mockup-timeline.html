<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Atlas · Timelines (Mockup alineado a Design System)</title>

  <!--
    ✅ CONVERSIÓN A VISTA REAL (Django/Atlas)
    - En producción, ESTE archivo NO debe traer estilos propios.
    - Debe heredar del layout base de Atlas (base.html) y cargar los CSS/JS oficiales.
    - Deja este mockup como guía de estructura/DOM y comportamiento.
  -->

  <style>
    /* =========================================================
      FALLBACK MINIMAL (solo para abrir este HTML suelto)
      En producción: eliminar y depender del CSS del Design System Atlas.
    ========================================================== */
    :root{
      --bg:#0b1220; --text:#e8eefc; --muted:#9bb0d3;
      --panel: rgba(255,255,255,.04);
      --border: rgba(255,255,255,.10);
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --radius: 18px;
      --monthpx: 18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 600px at 20% 0%, #14264b 0%, transparent 60%),
                  radial-gradient(900px 500px at 80% 10%, #1a2a5a 0%, transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .container{ max-width:1200px; margin:22px auto; padding:0 14px 28px; }

    /* Clases “tipo Atlas” (fallback visual) */
    .ds-topbar{
      position: sticky; top: 10px; z-index: 10;
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:14px 16px;
      border:1px solid rgba(255,255,255,.07);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .ds-brand{ display:flex; gap:10px; align-items:center; min-width:240px; }
    .ds-logo{ width:34px; height:34px; border-radius:12px;
      background: linear-gradient(135deg, #7aa2ff, #b58cff);
      box-shadow: 0 10px 22px rgba(122,162,255,.25);
    }
    .ds-h1{ margin:0; font-size:14px; line-height:1.1; letter-spacing:.2px; }
    .ds-sub{ margin:2px 0 0; font-size:12px; color:var(--muted); }

    .ds-actions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center; }
    .ds-field{
      display:flex; gap:8px; align-items:center;
      padding:10px 10px;
      border-radius:14px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.08);
    }
    .ds-label{ font-size:12px; color:var(--muted); white-space:nowrap; }
    .ds-select, .ds-input{
      appearance:none;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      font-size:13px;
      outline:none;
      min-width:190px;
    }
    .ds-btn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(122,162,255,.14);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-size:13px;
    }

    .ds-card{
      margin-top:14px;
      background: var(--panel);
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden; /* ✅ IMPORTANT: confina tooltip/barras al card */
    }
    .ds-card-header{
      padding:14px 16px 10px;
      display:flex; justify-content:space-between; align-items:flex-end; gap:12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
    }
    .ds-h2{ margin:0; font-size:16px; letter-spacing:.2px; }
    .ds-meta{ margin-top:6px; color:var(--muted); font-size:12px; display:flex; gap:10px; flex-wrap:wrap; }
    .ds-chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
    }
    .ds-dot{ width:8px; height:8px; border-radius:999px; background:#7aa2ff; box-shadow:0 0 0 6px rgba(122,162,255,.12); }

    .ds-legend{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center; color:var(--muted); font-size:12px; }
    .ds-swatch{
      display:inline-flex; align-items:center; gap:7px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .ds-swatch i{ width:10px; height:10px; border-radius:3px; display:inline-block; }

    /* Timeline area */
    .timeline-wrap{ position: relative; padding: 12px 0 16px; }
    .timeline-scroller{
      overflow-x: auto; overflow-y: hidden;
      padding: 10px 10px 14px;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }

    /* ✅ “canvas” vive dentro del card, dentro del scroller */
    .timeline-canvas{
      position: relative;
      border-radius: 16px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.06);
      min-height: 260px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
    }

    .timeline-grid{ position:absolute; inset:0; pointer-events:none; }
    .timeline-year-row{
      position:absolute; top:0; left:0; right:0; height:44px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex; align-items:flex-end;
      padding:10px 10px 8px;
      background: linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,0));
    }
    .timeline-year-row span{ font-weight:600; font-size:12px; letter-spacing:.3px; }

    .month-line{ position:absolute; top:44px; bottom:0; width:1px; background: rgba(255,255,255,.06); }
    .year-line{ position:absolute; top:44px; bottom:0; width:2px; background: rgba(122,162,255,.18); }

    .timeline-rows{ position: relative; padding-top: 52px; padding-bottom: 16px; }

    .lane{
      position: relative;
      margin: 10px 10px 0;
      padding: 10px 10px 14px;
      border-radius: 14px;
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.06);
    }
    .lane-title{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px; padding-bottom:8px;
      border-bottom:1px dashed rgba(255,255,255,.08);
    }
    .lane-title strong{ font-size:13px; letter-spacing:.2px; }
    .lane-title small{ font-size:12px; color:var(--muted); }

    .bars{ position:relative; min-height:110px; }
    .bar{
      position:absolute;
      height: 28px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 10px 18px rgba(0,0,0,.28);
      display:flex; align-items:center;
      padding: 0 10px; gap:10px;
      overflow:hidden;
      user-select:none;
      cursor: default;
    }
    .bar .tag{
      font-size: 11px; opacity:.9;
      padding:3px 8px; border-radius:999px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.12);
      white-space: nowrap;
    }
    .bar .txt{ display:flex; flex-direction:column; min-width:0; line-height:1.05; }
    .bar .txt b, .bar .txt span{
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .bar .txt b{ font-size:12px; }
    .bar .txt span{ font-size:11px; opacity:.9; }

    /* ✅ Tooltip confinado al card (NO fixed, NO body) */
    .timeline-tooltip{
      position: absolute; /* relativo al .timeline-panel */
      z-index: 50;
      pointer-events: none;
      background: rgba(15,26,46,.96);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 10px 12px;
      box-shadow: var(--shadow);
      min-width: 220px;
      max-width: 280px;
      opacity: 0;
      transform: translateY(6px);
      transition: opacity .12s ease, transform .12s ease;
    }
    .timeline-tooltip.show{ opacity:1; transform: translateY(0); }
    .timeline-tooltip .t1{ font-weight:700; font-size:13px; margin-bottom:4px; }
    .timeline-tooltip .t2{ font-size:12px; color:var(--muted); margin-bottom:6px; }
    .timeline-tooltip .t3{ font-size:12px; display:flex; gap:8px; flex-wrap:wrap; }
    .timeline-tooltip .pill{
      padding:4px 8px; border-radius:999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
    }

    .footer-note{ margin-top:10px; color:var(--muted); font-size:12px; padding: 0 16px; }

    @media (max-width: 720px){
      .ds-brand{ min-width:auto; }
      .ds-select{ min-width:160px; }
      .ds-legend{ justify-content:flex-start; }
    }
  </style>
</head>

<body>
  <!--
    ✅ CONVERSIÓN A VISTA REAL (Django)
    - Reemplaza <div class="container"> por el contenedor principal del layout Atlas.
    - Esta vista debería ir dentro del bloque content del template base.
  -->
  <main class="container">
    <!-- TOPBAR (usar componentes reales del DS Atlas) -->
    <header class="ds-topbar">
      <div class="ds-brand">
        <div class="ds-logo" aria-hidden="true"></div>
        <div>
          <h1 class="ds-h1">Atlas · Timelines</h1>
          <p class="ds-sub">1997 → hoy · meses visibles · empalmes apilados</p>
        </div>
      </div>

      <div class="ds-actions">
        <div class="ds-field">
          <span class="ds-label">Entidad</span>
          <!--
            ✅ Real:
            - En Atlas, reemplazar por el componente select del DS (clases/markup nativos).
            - Opcional: autocomplete si ya existe en Atlas.
          -->
          <select id="entityType" class="ds-select">
            <option value="persona">Persona</option>
            <option value="institucion">Institución</option>
          </select>
        </div>

        <div class="ds-field">
          <span class="ds-label">Selecciona</span>
          <select id="entitySelect" class="ds-select"></select>
        </div>

        <button class="ds-btn" id="btnToday" type="button">Ir a hoy</button>
      </div>
    </header>

    <!-- CARD / PANEL (debe ser el Card real de Atlas) -->
    <section class="ds-card timeline-panel" id="timelinePanel">
      <div class="ds-card-header">
        <div>
          <h2 class="ds-h2" id="headline">Timeline</h2>
          <div class="ds-meta">
            <span class="ds-chip"><span class="ds-dot" aria-hidden="true"></span><span id="subhead">Selecciona una entidad para ver cargos por periodo</span></span>
            <span class="ds-chip">Eje: años + 12 meses</span>
            <span class="ds-chip">Empalmes: apilado vertical</span>
          </div>
        </div>

        <div class="ds-legend" aria-label="Leyenda">
          <span class="ds-swatch"><i style="background:#7aa2ff"></i> Federal</span>
          <span class="ds-swatch"><i style="background:#6ee7b7"></i> Estatal</span>
          <span class="ds-swatch"><i style="background:#fbbf24"></i> Municipal</span>
          <span class="ds-swatch"><i style="background:#c084fc"></i> Partidista</span>
        </div>
      </div>

      <div class="timeline-wrap">
        <!-- ✅ Scroller horizontal nativo: vive DENTRO del card -->
        <div class="timeline-scroller" id="scroller" role="region" aria-label="Timeline horizontal">
          <div class="timeline-canvas" id="canvas">
            <div class="timeline-grid" id="grid"></div>
            <div class="timeline-rows" id="rows"></div>
          </div>
        </div>

        <p class="footer-note">
          Tip: pasa el mouse sobre una barra para ver el tooltip. En móvil, toca una barra.
        </p>

        <!-- ✅ Tooltip confinado al panel/card (NO en body) -->
        <div class="timeline-tooltip" id="tooltip" role="tooltip" aria-hidden="true"></div>
      </div>
    </section>
  </main>

  <script>
    /* =========================================================
      ✅ CONVERSIÓN A PRODUCCIÓN (Atlas)
      - Mueve este JS a static/atlas/.../timelines.js
      - Carga desde el pipeline real (bundler o staticfiles)
      - Sustituye DATA mock por fetch a endpoint JSON:
        /apps/atlas/api/timelines/?type=persona&id=123
    ========================================================== */

    // ===== Mock data (reemplaza por tu API después) =====
    const DATA = {
      personas: [
        {
          id: "persona_francisco",
          nombre: "Francisco Domínguez Servién",
          cargos: [
            { label:"Gobernador", institucion:"Gobierno del Estado de Querétaro", nivel:"estatal", inicio:"2015-10-01", fin:"2021-09-30" },
            { label:"Senador", institucion:"Senado de la República", nivel:"federal", inicio:"2012-09-01", fin:"2015-08-31" },
            { label:"Presidente Municipal", institucion:"Municipio de Querétaro", nivel:"municipal", inicio:"2009-10-01", fin:"2012-08-31" }
          ],
        },
        {
          id: "persona_agustin",
          nombre: "Agustín Dorantes Lámbarri",
          cargos: [
            { label:"Diputado Local", institucion:"Congreso del Estado de Querétaro", nivel:"estatal", inicio:"2021-09-26", fin:"2024-04-15" },
            { label:"Presidente estatal", institucion:"PAN Querétaro", nivel:"partidista", inicio:"2022-12-01", fin:"2024-03-10" }
          ],
        }
      ],
      instituciones: [
        {
          id: "inst_gobqro",
          nombre: "Gobierno del Estado de Querétaro",
          cargos: [
            { label:"Gobernador", persona:"Francisco Domínguez Servién", nivel:"estatal", inicio:"2015-10-01", fin:"2021-09-30" },
            { label:"Gobernador", persona:"— (Ejemplo previo)", nivel:"estatal", inicio:"2009-10-01", fin:"2015-09-30" }
          ],
        },
        {
          id: "inst_panqro",
          nombre: "PAN Querétaro",
          cargos: [
            { label:"Presidente estatal", persona:"Agustín Dorantes Lámbarri", nivel:"partidista", inicio:"2022-12-01", fin:"2024-03-10" }
          ],
        }
      ]
    };

    // ===== Timeline config =====
    const START_YEAR = 1997;
    const END_YEAR = new Date().getFullYear();
    const MONTH_PX = 18;     // en prod: conviértelo en token/variable DS si aplica
    const HEADER_H = 44;
    const LANE_BAR_H = 28;
    const STACK_GAP = 6;
    const PADDING_X = 10;

    const levelBg = {
      federal:   "linear-gradient(135deg, rgba(122,162,255,.85), rgba(122,162,255,.55))",
      estatal:   "linear-gradient(135deg, rgba(110,231,183,.85), rgba(110,231,183,.55))",
      municipal: "linear-gradient(135deg, rgba(251,191,36,.85), rgba(251,191,36,.55))",
      partidista:"linear-gradient(135deg, rgba(192,132,252,.85), rgba(192,132,252,.55))",
    };

    // ===== DOM =====
    const entityType = document.getElementById("entityType");
    const entitySelect = document.getElementById("entitySelect");
    const headline = document.getElementById("headline");
    const subhead = document.getElementById("subhead");
    const grid = document.getElementById("grid");
    const rows = document.getElementById("rows");
    const canvas = document.getElementById("canvas");
    const scroller = document.getElementById("scroller");
    const tooltip = document.getElementById("tooltip");
    const panel = document.getElementById("timelinePanel");

    document.getElementById("btnToday").addEventListener("click", scrollToToday);

    // Utils
    function parseDate(s){ const [y,m,d] = s.split("-").map(Number); return new Date(y, m-1, d||1); }
    function monthIndex(d){ return (d.getFullYear() - START_YEAR)*12 + d.getMonth(); }
    function totalMonths(){ return (END_YEAR - START_YEAR + 1)*12; }
    function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c])); }

    function formatMY(s){
      const d = parseDate(s);
      const months = ["ene","feb","mar","abr","may","jun","jul","ago","sep","oct","nov","dic"];
      return `${months[d.getMonth()]} ${d.getFullYear()}`;
    }

    function setCanvasWidth(){
      const w = totalMonths()*MONTH_PX + (PADDING_X*2);
      canvas.style.width = w + "px";
    }

    function buildGrid(){
      grid.innerHTML = "";
      setCanvasWidth();

      const yearRow = document.createElement("div");
      yearRow.className = "timeline-year-row";
      yearRow.innerHTML = `<span>${START_YEAR} → ${END_YEAR}</span>`;
      grid.appendChild(yearRow);

      const months = totalMonths();
      for(let i=0;i<=months;i++){
        const x = PADDING_X + i*MONTH_PX;
        const isYear = (i % 12 === 0);
        const line = document.createElement("div");
        line.className = isYear ? "year-line" : "month-line";
        line.style.left = x + "px";
        grid.appendChild(line);
      }

      // Year labels
      for(let y=START_YEAR; y<=END_YEAR; y++){
        const i = (y-START_YEAR)*12;
        const x = PADDING_X + i*MONTH_PX;
        const lab = document.createElement("div");
        lab.style.position = "absolute";
        lab.style.top = "10px";
        lab.style.left = (x + 6) + "px";
        lab.style.fontSize = "11px";
        lab.style.color = "rgba(155,176,211,.85)";
        lab.style.fontWeight = "600";
        lab.style.pointerEvents = "none";
        lab.textContent = String(y);
        grid.appendChild(lab);
      }
    }

    // Stacking overlaps
    function stackOverlaps(items){
      const segs = items.map(it=>{
        const s = parseDate(it.inicio);
        const e = parseDate(it.fin);
        return { ...it, _start: monthIndex(s), _end: monthIndex(e) };
      }).sort((a,b)=>a._start-b._start || a._end-b._end);

      const rowsEnd = [];
      for(const it of segs){
        let placed = false;
        for(let r=0;r<rowsEnd.length;r++){
          if(it._start > rowsEnd[r]){
            it._row = r; rowsEnd[r] = it._end; placed = true; break;
          }
        }
        if(!placed){ it._row = rowsEnd.length; rowsEnd.push(it._end); }
      }
      return { segs, rowCount: rowsEnd.length };
    }

    function clearTimeline(){
      rows.innerHTML = "";
      hideTip();
    }

    function renderLane(title, subtitle, items, mode){
      const lane = document.createElement("div");
      lane.className = "lane";
      lane.innerHTML = `
        <div class="lane-title">
          <strong>${escapeHtml(title)}</strong>
          <small>${escapeHtml(subtitle)}</small>
        </div>
        <div class="bars"></div>
      `;
      const barsWrap = lane.querySelector(".bars");

      const { segs, rowCount } = stackOverlaps(items);
      const neededH = Math.max(70, rowCount*(LANE_BAR_H + STACK_GAP) + 14);
      barsWrap.style.minHeight = neededH + "px";

      for(const it of segs){
        const startX = PADDING_X + it._start*MONTH_PX;
        const endX = PADDING_X + (it._end + 1)*MONTH_PX;
        const w = Math.max(MONTH_PX, endX - startX - 2);
        const y = 6 + it._row*(LANE_BAR_H + STACK_GAP);

        const bar = document.createElement("div");
        bar.className = "bar";
        bar.style.left = startX + "px";
        bar.style.top = y + "px";
        bar.style.width = w + "px";
        bar.style.background = levelBg[it.nivel] || "rgba(122,162,255,.25)";
        bar.setAttribute("tabindex","0");

        const main = (mode==="persona") ? it.label : it.persona;
        const sub  = (mode==="persona") ? it.institucion : `${it.label} · ${it.persona}`;

        bar.innerHTML = `
          <span class="tag">${escapeHtml(it.nivel)}</span>
          <div class="txt">
            <b title="${escapeHtml(main)}">${escapeHtml(main)}</b>
            <span title="${escapeHtml(sub)}">${escapeHtml(sub)}</span>
          </div>
        `;

        // ✅ Tooltip: anclado al PANEL y clamped dentro del card
        const ttTitle = (mode==="persona") ? it.label : it.persona;
        const ttSub   = (mode==="persona") ? it.institucion : it.label;

        bar.addEventListener("mouseenter", ()=>showTipForBar(bar, ttTitle, ttSub, it.nivel, it.inicio, it.fin));
        bar.addEventListener("focus", ()=>showTipForBar(bar, ttTitle, ttSub, it.nivel, it.inicio, it.fin));
        bar.addEventListener("mouseleave", hideTip);
        bar.addEventListener("blur", hideTip);

        bar.addEventListener("click", ()=>{
          showTipForBar(bar, ttTitle, ttSub, it.nivel, it.inicio, it.fin);
          if(window.matchMedia("(max-width: 720px)").matches){
            setTimeout(hideTip, 1600);
          }
        });

        barsWrap.appendChild(bar);
      }

      rows.appendChild(lane);
    }

    function showTipForBar(barEl, title, sub, nivel, inicio, fin){
      tooltip.innerHTML = `
        <div class="t1">${escapeHtml(title)}</div>
        <div class="t2">${escapeHtml(sub)}</div>
        <div class="t3">
          <span class="pill">${escapeHtml(nivel)}</span>
          <span class="pill">${escapeHtml(formatMY(inicio))} – ${escapeHtml(formatMY(fin))}</span>
        </div>
      `;
      tooltip.classList.add("show");
      tooltip.setAttribute("aria-hidden","false");
      positionTip(barEl);
    }

    function positionTip(barEl){
      // ✅ POSICIONAMIENTO RELATIVO AL PANEL (no viewport, no body)
      const panelRect = panel.getBoundingClientRect();
      const barRect   = barEl.getBoundingClientRect();

      // Medimos tooltip ya visible
      const ttRect = tooltip.getBoundingClientRect();

      // Preferencia: arriba de la barra
      let left = (barRect.left - panelRect.left) + (barRect.width/2) - (ttRect.width/2);
      let top  = (barRect.top  - panelRect.top)  - ttRect.height - 10;

      // Si no cabe arriba, lo ponemos abajo
      if(top < 8){
        top = (barRect.bottom - panelRect.top) + 10;
      }

      // Clamp a límites del panel
      const pad = 10;
      left = clamp(left, pad, panelRect.width - ttRect.width - pad);
      top  = clamp(top,  pad, panelRect.height - ttRect.height - pad);

      tooltip.style.left = left + "px";
      tooltip.style.top  = top + "px";
    }

    function hideTip(){
      tooltip.classList.remove("show");
      tooltip.setAttribute("aria-hidden","true");
    }

    // Mantener tooltip alineado al hacer scroll horizontal
    let raf = null;
    scroller.addEventListener("scroll", ()=>{
      if(!tooltip.classList.contains("show")) return;
      if(raf) cancelAnimationFrame(raf);
      raf = requestAnimationFrame(()=>{
        const active = document.querySelector(".bar:focus") || document.querySelector(".bar:hover");
        if(active) positionTip(active);
      });
    }, { passive:true });

    // ESC cierra tooltip (accesibilidad)
    window.addEventListener("keydown", (e)=>{
      if(e.key === "Escape") hideTip();
    });

    function renderTimeline(){
      clearTimeline();
      buildGrid();

      const type = entityType.value;
      const id = entitySelect.value;

      if(type === "persona"){
        const p = DATA.personas.find(x=>x.id===id);
        headline.textContent = `Timeline · ${p.nombre}`;
        subhead.textContent = "Cargos ocupados (apilado cuando hay empalmes)";
        renderLane("Cargos", "Barras = periodos de cargos · meses visibles", p.cargos, "persona");
      } else {
        const inst = DATA.instituciones.find(x=>x.id===id);
        headline.textContent = `Timeline · ${inst.nombre}`;
        subhead.textContent = "Personas y cargos por periodo dentro de la institución";
        renderLane("Ocupación de cargos", "Barras = personas en el tiempo · apilado si se empalman", inst.cargos, "institucion");
      }

      scrollNearYear(2010);
    }

    function populateEntities(){
      const type = entityType.value;
      entitySelect.innerHTML = "";
      const list = (type==="persona") ? DATA.personas : DATA.instituciones;
      for(const it of list){
        const opt = document.createElement("option");
        opt.value = it.id;
        opt.textContent = it.nombre;
        entitySelect.appendChild(opt);
      }
    }

    function scrollNearYear(year){
      const idx = (year - START_YEAR)*12;
      scroller.scrollLeft = Math.max(0, idx*MONTH_PX - 200);
    }

    function scrollToToday(){
      const idx = monthIndex(new Date());
      scroller.scrollLeft = Math.max(0, idx*MONTH_PX - 260);
    }

    entityType.addEventListener("change", ()=>{ populateEntities(); renderTimeline(); });
    entitySelect.addEventListener("change", renderTimeline);

    // Init
    populateEntities();
    renderTimeline();
  </script>
</body>
</html>