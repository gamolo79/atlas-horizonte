{% extends "sintesis/base.html" %}

{% block title %}Síntesis · {{ client.name }}{% endblock %}

{% block content %}
<div class="card">
  <h2>Cliente · {{ client.name }}</h2>
  <p class="muted">Configura los intereses editoriales, etiquetas clave y agenda de síntesis.</p>
  <form method="post">
    {% csrf_token %}
    <div class="form-grid">
      <div>
        <label for="id_client-name">Nombre</label>
        {{ client_form.name }}
      </div>
      <div>
        <label for="id_client-persona">Persona Atlas</label>
        {{ client_form.persona }}
      </div>
      <div>
        <label for="id_client-institucion">Institución Atlas</label>
        {{ client_form.institucion }}
      </div>
      <div>
        <label for="id_client-description">Descripción</label>
        {{ client_form.description }}
      </div>
      <div>
        <label for="id_client-keyword_tags">Tags clave</label>
        {{ client_form.keyword_tags }}
      </div>
      <div>
        <label for="id_client-is_active">Activo</label>
        {{ client_form.is_active }}
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <button class="btn" type="submit" name="save_client">Guardar cambios</button>
      <a class="btn ghost" href="{% url 'sintesis:client_stories' client.id %}">Ver síntesis completas</a>
    </div>
  </form>
</div>

<div class="grid cols" style="margin-top:16px">
  <div class="grid cols" style="margin-top:16px; align-items: start;">
    <div class="card">
      <h2>Estructura del Reporte</h2>
      <p class="muted">Define las secciones del documento. Crea una sección llamada "Notas principales" (Orden 10) para
        reemplazar la configuración por defecto.</p>
      <div class="list" style="margin-top:12px">
        {% for section in sections %}
        <div class="item">
          <div>
            <div class="title">{{ section.title }}</div>
            <div class="meta">Agrupar por {{ section.get_group_by_display }} · Orden {{ section.order }}</div>
            <div class="chips" style="margin-top:8px">
              {% for filter in section.filters.all %}
              <span class="chip">
                {% if filter.persona %}{{ filter.persona.nombre_completo }}{% endif %}
                {% if filter.institucion %}{{ filter.institucion.nombre }}{% endif %}
                {% if filter.topic %}{{ filter.topic.name }}{% endif %}
                {% if filter.keywords %}{{ filter.keywords }}{% endif %}
              </span>
              {% endfor %}
            </div>
          </div>
          <div class="row" style="gap:6px">
            <span class="pill {% if section.is_active %}brand{% else %}warn{% endif %}">
              {% if section.is_active %}Activa{% else %}Inactiva{% endif %}
            </span>
            <a class="btn ghost" style="padding:4px 8px" href="?edit_section={{ section.id }}">Editar</a>
            <form method="post" action="{% url 'sintesis:delete_section' section.id %}"
              onsubmit="return confirm('¿Eliminar sección?');">
              {% csrf_token %}
              <button type="submit" class="btn ghost"
                style="padding:4px 8px;color:#ef4444;border:none">Eliminar</button>
            </form>
          </div>
        </div>
        {% empty %}
        <div class="item">
          <div>
            <div class="title">Sin secciones configuradas</div>
            <div class="meta">Agrega una sección para personalizar el documento.</div>
          </div>
        </div>
        {% endfor %}
      </div>

      <form method="post" style="margin-top:14px">
        {% csrf_token %}
        {% if editing_section %}
        <div class="meta" style="margin-bottom:8px">Editando "{{ editing_section.title }}".</div>
        <input type="hidden" name="section_id" value="{{ editing_section.id }}">
        {% endif %}
        <div>
          <div class="title">{{ story.title }}</div>
          <div class="meta">{{ story.summary }}</div>
          <div class="meta">{{ story.article_count }} notas</div>
        </div>
        <div class="chips">
          {% for item in story.story_articles.all %}
          <span class="chip"><a href="{{ item.source_url }}" target="_blank">{{ item.source_name }}</a></span>
          {% endfor %}
        </div>
    </div>
    {% empty %}
    <div class="item">
      <div>
        <div class="title">Aún no hay síntesis</div>
        <div class="meta">Ejecuta un proceso para generar resúmenes.</div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<div class="card">
  <h2>Historial de ejecuciones</h2>
  <div class="list">
    {% for run in runs %}
    <div class="item">
      <div>
        <div class="title">{{ run.get_run_type_display }} · {{ run.status|upper }}</div>
        <div class="meta">{{ run.started_at|date:"d/m/Y H:i"|default:"—" }}</div>
        <div class="meta">{{ run.output_count }} historias</div>
      </div>
      <span class="pill info">{{ run.status }}</span>
      <div class="row" style="margin-top:8px">
        <a href="{% url 'sintesis:run_detail' run.id %}" target="_blank" class="btn ghost"
          style="padding:4px 8px;font-size:11px">Ver documento</a>
        {% if run.pdf_file %}
        <a href="{% url 'sintesis:run_pdf' run.id %}" target="_blank" class="btn ghost"
          style="padding:4px 8px;font-size:11px">PDF</a>
        {% endif %}
      </div>
    </div>
    {% empty %}
    <div class="item">
      <div>
        <div class="title">Sin ejecuciones registradas</div>
        <div class="meta">Las ejecuciones aparecerán aquí.</div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
</div>
{% endblock %}