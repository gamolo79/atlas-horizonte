{% extends "monitor/dashboard/base.html" %}
{% block title %}Benchmark · Monitor{% endblock %}
{% block content %}
  <div class="page-header">
    <div>
      <h1 class="page-title">Benchmark de personas</h1>
      <p class="muted">Comparativa de cobertura mediática.</p>
    </div>
    <a class="actions" href="/monitor/dashboard/personas/">Explorar personas</a>
  </div>

  <form method="get" class="card" style="margin-bottom: 20px;">
    <div class="form-row">
      <div>
        <label class="muted">Persona A</label><br>
        <select class="input" name="a">
          <option value="">Selecciona</option>
          {% for persona in personas %}
            <option value="{{ persona.id }}" {% if persona_a and persona_a.id == persona.id %}selected{% endif %}>
              {{ persona.nombre_completo }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="muted">Persona B</label><br>
        <select class="input" name="b">
          <option value="">Selecciona</option>
          {% for persona in personas %}
            <option value="{{ persona.id }}" {% if persona_b and persona_b.id == persona.id %}selected{% endif %}>
              {{ persona.nombre_completo }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="muted">Días</label><br>
        <input class="input" type="number" name="days" value="{{ days }}" min="1" max="365">
      </div>
      <div class="actions" style="align-self: flex-end;">
        <button type="submit">Comparar</button>
      </div>
    </div>
  </form>

  <section class="grid grid-2">
    <div class="card">
      <h3>{{ persona_a.nombre_completo|default:"Persona A" }}</h3>
      {% if metrics_a %}
        <p class="muted">Menciones: {{ metrics_a.mentions_count }}</p>
        <p class="muted">Artículos: {{ metrics_a.articles_count }}</p>
      {% else %}
        <p class="table-empty">Selecciona una persona para ver métricas.</p>
      {% endif %}
    </div>
    <div class="card">
      <h3>{{ persona_b.nombre_completo|default:"Persona B" }}</h3>
      {% if metrics_b %}
        <p class="muted">Menciones: {{ metrics_b.mentions_count }}</p>
        <p class="muted">Artículos: {{ metrics_b.articles_count }}</p>
      {% else %}
        <p class="table-empty">Selecciona una persona para ver métricas.</p>
      {% endif %}
    </div>
  </section>

  <section class="grid" style="margin-top: 20px;">
    <div class="card chart-card">
      <div class="chart-header">
        <h3 class="chart-title">Comparativo de métricas</h3>
        <div class="chart-subtitle">Menciones y artículos en la ventana seleccionada.</div>
      </div>
      <div class="chart-container">
        <canvas id="personaBenchmarkChart" aria-label="Comparativo de métricas" role="img"></canvas>
      </div>
    </div>
    <div class="card chart-card">
      <div class="chart-header">
        <h3 class="chart-title">Top medios combinados</h3>
        <div class="chart-subtitle">Presencia total en los outlets más activos.</div>
      </div>
      <div class="chart-container">
        <canvas id="personaOutletsBenchmarkChart" aria-label="Top medios combinados" role="img"></canvas>
      </div>
    </div>
  </section>

  <section class="card" style="margin-top: 20px;">
    <h3>Medios combinados más activos</h3>
    <table>
      <thead>
        <tr>
          <th>Medio</th>
          <th>Presencia total</th>
        </tr>
      </thead>
      <tbody>
        {% for outlet, total in top_outlets %}
          <tr>
            <td>{{ outlet }}</td>
            <td>{{ total }}</td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="2" class="table-empty">Aún no hay datos para comparar.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
{% endblock %}

{% block extra_scripts %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    const compareLabels = ["Menciones", "Artículos"];
    const personaALabel = "{{ persona_a.nombre_completo|default:'Persona A'|escapejs }}";
    const personaBLabel = "{{ persona_b.nombre_completo|default:'Persona B'|escapejs }}";
    const personaAData = [{{ metrics_a.mentions_count|default:0 }}, {{ metrics_a.articles_count|default:0 }}];
    const personaBData = [{{ metrics_b.mentions_count|default:0 }}, {{ metrics_b.articles_count|default:0 }}];

    new Chart(document.getElementById("personaBenchmarkChart"), {
      type: "bar",
      data: {
        labels: compareLabels,
        datasets: [
          {
            label: personaALabel,
            data: personaAData,
            backgroundColor: "rgba(34, 197, 94, 0.75)",
          },
          {
            label: personaBLabel,
            data: personaBData,
            backgroundColor: "rgba(56, 189, 248, 0.7)",
          },
        ],
      },
      options: {
        scales: {
          x: { ticks: { color: "#cbd5f5" } },
          y: { ticks: { color: "#cbd5f5" } },
        },
        plugins: {
          legend: { labels: { color: "#e2e8f0" } },
        },
      },
    });

    const outletLabels = [{% for outlet, total in top_outlets %}"{{ outlet|escapejs }}",{% endfor %}];
    const outletValues = [{% for outlet, total in top_outlets %}{{ total }},{% endfor %}];

    new Chart(document.getElementById("personaOutletsBenchmarkChart"), {
      type: "bar",
      data: {
        labels: outletLabels,
        datasets: [{
          label: "Presencia total",
          data: outletValues,
          backgroundColor: "rgba(34, 197, 94, 0.6)",
        }],
      },
      options: {
        scales: {
          x: { ticks: { color: "#cbd5f5" } },
          y: { ticks: { color: "#cbd5f5" } },
        },
        plugins: {
          legend: { labels: { color: "#e2e8f0" } },
        },
      },
    });
  </script>
{% endblock %}
