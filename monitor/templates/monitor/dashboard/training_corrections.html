{% extends "monitor/dashboard/base.html" %}
{% block title %}Entrenamiento · Monitor{% endblock %}
{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Entrenamiento del Modelo</h1>
        <p class="page-subtitle">Corrige clasificaciones para mejorar la precisión del modelo de análisis.</p>
    </div>
    <div class="actions">
        <a class="secondary" href="/monitor/dashboard/">Volver a Home</a>
    </div>
</div>

<section class="card">
    <h3 class="card-title">Últimos Artículos (Corrección Editorial)</h3>
    <p class="card-desc">Corrige temas, sentimiento y clasificación de los artículos recientes para entrenar al modelo.
    </p>
    <table>
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Medio</th>
                <th>Titular</th>
                <th>Temas</th>
                <th>Personas</th>
                <th>Instituciones</th>
                <th>Sentimiento</th>
                <th>Tipo</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for article in recent_articles %}
            <tr>
                <td>{{ article.published_at|date:"H:i" }}</td>
                <td>{{ article.media_outlet.name }}</td>
                <td>
                    <a href="{{ article.url }}" target="_blank" style="color:var(--text); text-decoration:none;">
                        {{ article.title|truncatechars:50 }}
                    </a>
                </td>
                <td>
                    {% for topic in article.topics|slice:":2" %}
                    <span class="pill" style="font-size:10px;">{{ topic.label|default:topic }}</span>
                    {% endfor %}
                </td>
                <td>
                    {% for mention in article.person_mentions.all|slice:":2" %}
                    <span class="pill" style="font-size:10px;">{{ mention.persona.nombre_completo }}</span>
                    {% endfor %}
                </td>
                <td>
                    {% for mention in article.institution_mentions.all|slice:":2" %}
                    <span class="pill" style="font-size:10px;">{{ mention.institucion.nombre }}</span>
                    {% endfor %}
                </td>
                <td>
                    {% if article.sentiment %}
                    {% if article.sentiment.sentiment == "positivo" %}
                    <span class="kpi-pill positive" style="font-size:10px;">Positivo</span>
                    {% elif article.sentiment.sentiment == "negativo" %}
                    <span class="kpi-pill negative" style="font-size:10px;">Negativo</span>
                    {% else %}
                    <span class="kpi-pill neutral" style="font-size:10px;">Neutro</span>
                    {% endif %}
                    {% else %}
                    <span style="font-size:10px; color:var(--muted);">—</span>
                    {% endif %}
                </td>
                <td>
                    {% if article.content_classification %}
                    <span class="pill" style="font-size:10px;">{{ article.content_classification.content_type|title }}</span>
                    {% else %}
                    <span style="font-size:10px; color:var(--muted);">—</span>
                    {% endif %}
                </td>
                <td>
                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                        <button class="actions ghost" style="padding: 4px 8px; font-size: 12px; cursor: pointer;"
                            onclick="openModal('{{ article.id }}', '{{ article.title|escapejs }}', 'topic', '{% if article.sentiment %}{{ article.sentiment.sentiment }}{% endif %}', '{% if article.content_classification %}{{ article.content_classification.content_type }}{% endif %}')">
                            Corregir tema
                        </button>
                        <button class="actions ghost" style="padding: 4px 8px; font-size: 12px; cursor: pointer;"
                            onclick="openModal('{{ article.id }}', '{{ article.title|escapejs }}', 'sentiment', '{% if article.sentiment %}{{ article.sentiment.sentiment }}{% endif %}', '{% if article.content_classification %}{{ article.content_classification.content_type }}{% endif %}')">
                            Corregir sentimiento
                        </button>
                        <button class="actions ghost" style="padding: 4px 8px; font-size: 12px; cursor: pointer;"
                            onclick="openModal('{{ article.id }}', '{{ article.title|escapejs }}', 'article_type', '{% if article.sentiment %}{{ article.sentiment.sentiment }}{% endif %}', '{% if article.content_classification %}{{ article.content_classification.content_type }}{% endif %}')">
                            Corregir tipo
                        </button>
                        <button class="actions ghost" style="padding: 4px 8px; font-size: 12px; cursor: pointer;"
                            onclick="discardArticle('{{ article.id }}', '{{ article.title|escapejs }}')">
                            Descartar nota
                        </button>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="9" class="table-empty">Sin artículos recientes.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</section>

<!-- Store topics data as hidden inputs -->
{% for article in recent_articles %}
<input type="hidden" id="topics-{{ article.id }}" value="{{ article.topics|escapejs }}">
<input type="hidden" id="personas-{{ article.id }}" value="{{ article.persona_ids_json|escapejs }}">
<input type="hidden" id="instituciones-{{ article.id }}" value="{{ article.institucion_ids_json|escapejs }}">
{% endfor %}

<!-- Article Correction Modal (Topics, Sentiment, Classification) -->
<dialog id="articleModal"
    style="background: var(--surface); border: 1px solid var(--border); color: var(--text); padding: 20px; border-radius: 12px; max-width: 500px; margin: auto;">
    <form method="dialog">
        <h3 style="margin-top:0;" id="articleModalTitle">Corregir Artículo</h3>
        <p id="articleModalRefText" style="font-size: 12px; color: var(--muted); margin-bottom: 16px;"></p>

        <input type="hidden" id="articleModalObjectId">

        <div data-correction-section="topic">
            <!-- Topics -->
            <label>Temas (separados por comas):</label>
            <input type="text" id="articleTopicInput" placeholder="Ej: Política, Seguridad, Economía..."
                style="margin-bottom: 8px;">
            <div style="font-size: 11px; color: var(--muted); margin-bottom: 16px;">
                Escribe varios temas separados por comas.
            </div>

            <!-- Personas Mencionadas -->
            <label>Personas Mencionadas:</label>
            <select id="articlePersonasSelect" multiple style="margin-bottom: 8px; height: 120px;">
                {% for persona in all_personas %}
                <option value="{{ persona.id }}">{{ persona.nombre_completo }}</option>
                {% endfor %}
            </select>
            <div style="font-size: 11px; color: var(--muted); margin-bottom: 16px;">
                Mantén presionado Ctrl (Cmd en Mac) para seleccionar varias personas.
            </div>

            <!-- Instituciones Mencionadas -->
            <label>Instituciones Mencionadas:</label>
            <select id="articleInstitucionesSelect" multiple style="margin-bottom: 8px; height: 120px;">
                {% for institucion in all_instituciones %}
                <option value="{{ institucion.id }}">{{ institucion.nombre }}</option>
                {% endfor %}
            </select>
            <div style="font-size: 11px; color: var(--muted); margin-bottom: 16px;">
                Mantén presionado Ctrl (Cmd en Mac) para seleccionar varias instituciones.
            </div>
        </div>

        <div data-correction-section="sentiment">
            <!-- Sentiment -->
            <label>Sentimiento:</label>
            <select id="articleSentimentSelect" style="margin-bottom: 16px;">
                <option value="">Sin clasificar</option>
                <option value="positivo">Positivo</option>
                <option value="neutro">Neutro</option>
                <option value="negativo">Negativo</option>
            </select>
        </div>

        <div data-correction-section="article_type">
            <!-- Article Type (Información vs Opinión) -->
            <label>Clasificación:</label>
            <select id="articleTypeSelect" style="margin-bottom: 16px;">
                <option value="">Sin clasificar</option>
                <option value="informacion">Información</option>
                <option value="opinion">Opinión</option>
            </select>
        </div>

        <div class="actions" style="justify-content: flex-end;">
            <button value="cancel" class="ghost" type="button"
                onclick="document.getElementById('articleModal').close()">Cancelar</button>
            <button type="button" onclick="submitArticleCorrection()" style="background: var(--primary);">Guardar
                Corrección</button>
        </div>
    </form>
</dialog>

<script>
    const articleModal = document.getElementById("articleModal");
    const articleModalObjectId = document.getElementById("articleModalObjectId");
    const articleTopicInput = document.getElementById("articleTopicInput");
    const articleSentimentSelect = document.getElementById("articleSentimentSelect");
    const articleTypeSelect = document.getElementById("articleTypeSelect");
    const articlePersonasSelect = document.getElementById("articlePersonasSelect");
    const articleInstitucionesSelect = document.getElementById("articleInstitucionesSelect");
    const articleModalRefText = document.getElementById("articleModalRefText");
    const articleModalTitle = document.getElementById("articleModalTitle");
    const correctionSections = document.querySelectorAll("[data-correction-section]");
    let activeCorrectionType = "topic";

    function openModal(articleId, title, correctionType, sentiment, articleType) {
        articleModalObjectId.value = articleId;
        articleModalRefText.innerText = title;
        activeCorrectionType = correctionType;
        articleModalTitle.innerText = getCorrectionTitle(correctionType);

        // Get and parse topics from hidden input
        const topicsInput = document.getElementById('topics-' + articleId);
        if (topicsInput) {
            try {
                const topicsValue = topicsInput.value;
                const topics = topicsValue ? JSON.parse(topicsValue) : [];
                const topicLabels = topics.map(t => t.label || t).join(', ');
                articleTopicInput.value = topicLabels;
            } catch (e) {
                console.error("Error parsing topics:", e);
                articleTopicInput.value = "";
            }
        }

        // Populate sentiment
        articleSentimentSelect.value = sentiment || "";

        // Populate article type
        articleTypeSelect.value = articleType || "";

        // Clear personas and instituciones selection
        for (let option of articlePersonasSelect.options) {
            option.selected = false;
        }
        for (let option of articleInstitucionesSelect.options) {
            option.selected = false;
        }

        const personasInput = document.getElementById('personas-' + articleId);
        if (personasInput) {
            try {
                const personasValue = personasInput.value;
                const personaIds = personasValue ? JSON.parse(personasValue) : [];
                for (let option of articlePersonasSelect.options) {
                    option.selected = personaIds.includes(parseInt(option.value, 10));
                }
            } catch (e) {
                console.error("Error parsing personas:", e);
            }
        }

        const institucionesInput = document.getElementById('instituciones-' + articleId);
        if (institucionesInput) {
            try {
                const institucionesValue = institucionesInput.value;
                const institucionIds = institucionesValue ? JSON.parse(institucionesValue) : [];
                for (let option of articleInstitucionesSelect.options) {
                    option.selected = institucionIds.includes(parseInt(option.value, 10));
                }
            } catch (e) {
                console.error("Error parsing instituciones:", e);
            }
        }

        toggleCorrectionSections(correctionType);
        articleModal.showModal();
    }

    function toggleCorrectionSections(correctionType) {
        correctionSections.forEach(section => {
            const sectionType = section.getAttribute("data-correction-section");
            section.style.display = sectionType === correctionType ? "block" : "none";
        });
    }

    function getCorrectionTitle(correctionType) {
        switch (correctionType) {
            case "sentiment":
                return "Corregir Sentimiento";
            case "article_type":
                return "Corregir Tipo";
            case "topic":
            default:
                return "Corregir Tema";
        }
    }

    function submitArticleCorrection() {
        const id = articleModalObjectId.value;
        const topicInputValue = articleTopicInput.value.trim();
        const sentiment = articleSentimentSelect.value;
        const articleType = articleTypeSelect.value;
        const refText = articleModalRefText.innerText;

        // Get selected personas and instituciones
        const selectedPersonas = Array.from(articlePersonasSelect.selectedOptions).map(opt => opt.value);
        const selectedInstituciones = Array.from(articleInstitucionesSelect.selectedOptions).map(opt => opt.value);

        const topics = topicInputValue.split(',').map(t => t.trim()).filter(t => t.length > 0).map(label => ({ label, confidence: "alta" }));

        if (activeCorrectionType === "topic") {
            if (topics.length > 0) submitCorrection(id, "topic", topics, refText);
            if (selectedPersonas.length > 0) submitCorrection(id, "article_personas", selectedPersonas, refText);
            if (selectedInstituciones.length > 0) submitCorrection(id, "article_instituciones", selectedInstituciones, refText);
        }
        if (activeCorrectionType === "sentiment" && sentiment) {
            submitCorrection(id, "sentiment_article", sentiment, refText);
        }
        if (activeCorrectionType === "article_type" && articleType) {
            submitCorrection(id, "article_type", articleType, refText);
        }

        setTimeout(() => {
            alert("Correcciones guardadas.");
            articleModal.close();
            window.location.reload();
        }, 500);
    }

    function submitCorrection(id, correctionType, newValue, refText) {

        fetch("/monitor/dashboard/ops/correction/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({
                object_id: id,
                model_name: "article",
                correction_type: correctionType,
                new_value: newValue,
                reference_text: refText
            })
        })
            .then(res => res.json())
            .then(data => {
                if (data.status !== "success") console.error("Error:", data.error);
            })
            .catch(err => console.error("Error:", err));
    }

    function discardArticle(articleId, title) {
        if (!confirm(`¿Descartar la nota "${title}" del listado de entrenamiento?`)) {
            return;
        }
        submitCorrection(articleId, "training_discard", true, title);
        setTimeout(() => {
            window.location.reload();
        }, 300);
    }
</script>
{% endblock %}
