{% extends "monitor/dashboard/base.html" %}
{% block title %}Home · Monitor{% endblock %}
{% block content %}
<div class="page-header">
  <div>
    <h1 class="page-title">Monitor · Centro de cobertura</h1>
    <p class="page-subtitle">Accede a dashboards, comparativos y digests para monitorear cobertura en medios.</p>
  </div>
  <div class="actions">
    <a class="secondary" href="/monitor/dashboard/ingest/">Ingest/Digest</a>
    <a href="/monitor/dashboard/clients/">Clientes</a>
  </div>
</div>

<section class="panel hero">
  <div>
    <h2 class="hero-title">Sigue la conversación pública con atajos a lo esencial.</h2>
    <p class="hero-subtitle">
      Monitor consolida métricas de cobertura, comparativos entre actores y síntesis automáticas.
      Elige una ruta rápida para comenzar a analizar personas, instituciones y temas.
    </p>
    <div class="actions" style="margin-top: 14px;">
      <a class="pill" href="/monitor/dashboard/personas/">Personas</a>
      <a class="pill" href="/monitor/dashboard/instituciones/">Instituciones</a>
      <a class="pill" href="/monitor/dashboard/benchmark/">Benchmark</a>
      <a class="pill" href="/monitor/dashboard/ingest/">Digest</a>
    </div>
  </div>
  <div class="card">
    <h3 class="card-title">Estado del día</h3>
    <p class="card-desc">KPIs clave para entender la producción editorial más reciente.</p>
    <div class="grid grid-3" style="margin-top: 14px;">
      <div>
        <div class="kpi-label">Ingestas OK</div>
        <div class="kpi-value" style="color: var(--primary-soft);">{{ kpis.ingests_ok }}</div>
        <div class="kpi-subtitle">Procesos completados</div>
      </div>
      <div>
        <div class="kpi-label">Artículos hoy</div>
        <div class="kpi-value">{{ kpis.articles_today }}</div>
        <div class="kpi-subtitle">Cobertura diaria</div>
      </div>
      <div>
        <div class="kpi-label">Clusters hoy</div>
        <div class="kpi-value">{{ kpis.clusters_today }}</div>
        <div class="kpi-subtitle">Temas activos</div>
      </div>
    </div>
  </div>
</section>

<section class="panel" style="margin-top: 20px;">
  <h3 class="panel-title">Entrar rápido</h3>
  <p class="panel-subtitle">Explora dashboards por tipo de actor o revisa comparativos listos para presentar.</p>
  <div class="grid grid-3">
    <a class="card card-link" href="/monitor/dashboard/personas/">
      <div class="card-title">Dashboard de personas</div>
      <p class="card-desc">Menciones, medios, sentimiento y temas por actor público.</p>
      <div class="card-meta">Cobertura individual</div>
    </a>
    <a class="card card-link" href="/monitor/dashboard/instituciones/">
      <div class="card-title">Dashboard de instituciones</div>
      <p class="card-desc">Visibilidad institucional con breakdown por medios y temas.</p>
      <div class="card-meta">Cobertura institucional</div>
    </a>
    <a class="card card-link" href="/monitor/dashboard/benchmark/">
      <div class="card-title">Benchmark</div>
      <p class="card-desc">Comparativos rápidos de presencia mediática entre dos actores.</p>
      <div class="card-meta">Comparativos</div>
    </a>
  </div>
</section>

<section class="grid grid-2" style="margin-top: 20px;">
  <div class="card">
    <h3 class="card-title">Digest más reciente</h3>
    <p class="card-desc">Acceso directo a la última síntesis editorial generada.</p>
    <div class="actions" style="margin-top: 12px;">
      {% if digest_latest %}
      <a class="secondary" href="/monitor/dashboard/digests/{{ digest_latest.id }}/">Ver digest último</a>
      {% else %}
      <a class="secondary" href="/monitor/dashboard/ingest/">Generar digest</a>
      {% endif %}
      <a href="/monitor/dashboard/clients/">Configurar alertas</a>
    </div>
  </div>
  <div class="card">
    <h3 class="card-title">Últimas ingestas</h3>
    <p class="card-desc">Revisa ventanas recientes para validar la cobertura incorporada.</p>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Status</th>
          <th>Ventana</th>
        </tr>
      </thead>
      <tbody>
        {% for run in recent_runs %}
        <tr>
          <td>#{{ run.id }}</td>
          <td><span class="tag">{{ run.get_status_display }}</span></td>
          <td>{{ run.time_window_start|date:"d M H:i" }} → {{ run.time_window_end|date:"d M H:i" }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="3" class="table-empty">No hay ingestas recientes.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<section class="card" style="margin-top: 20px;">
  <h3 class="card-title">Últimos Artículos (Corrección de Temas)</h3>
  <p class="card-desc">Entrena al modelo corrigiendo los temas de los artículos recientes.</p>
  <table>
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Medio</th>
        <th>Titular</th>
        <th>Temas Actuales</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for article in recent_articles %}
      <tr>
        <td>{{ article.published_at|date:"H:i" }}</td>
        <td>{{ article.media_outlet.name }}</td>
        <td>
          <a href="{{ article.url }}" target="_blank" style="color:var(--text); text-decoration:none;">
            {{ article.title|truncatechars:50 }}
          </a>
        </td>
        <td>
          {% for topic in article.topics|slice:":2" %}
          <span class="pill" style="font-size:10px;">{{ topic.label|default:topic }}</span>
          {% endfor %}
        </td>
        <td>
          <button class="actions ghost" style="padding: 4px 8px; font-size: 12px; cursor: pointer;"
            onclick="openTopicModal('{{ article.id }}', '{{ article.title|escapejs }}')">
            Corregir Tema
          </button>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="5" class="table-empty">Sin artículos recientes.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>

<!-- Topic Correction Modal -->
<dialog id="topicModal"
  style="background: var(--surface); border: 1px solid var(--border); color: var(--text); padding: 20px; border-radius: 12px; max-width: 400px; margin: auto;">
  <form method="dialog">
    <h3 style="margin-top:0;">Corregir Tema Principal</h3>
    <p id="topicModalRefText" style="font-size: 12px; color: var(--muted); margin-bottom: 16px;"></p>

    <input type="hidden" id="topicModalObjectId">

    <label>Nuevo Tema Principal:</label>
    <input type="text" id="topicInput" placeholder="Ej: Política, Seguridad..." style="margin-bottom: 16px;">

    <div class="actions" style="justify-content: flex-end;">
      <button value="cancel" class="ghost" type="button"
        onclick="document.getElementById('topicModal').close()">Cancelar</button>
      <button type="button" onclick="submitTopicCorrection()" style="background: var(--primary);">Guardar</button>
    </div>
  </form>
</dialog>

<script>
  const topicModal = document.getElementById("topicModal");
  const topicModalObjectId = document.getElementById("topicModalObjectId");
  const topicInput = document.getElementById("topicInput");
  const topicModalRefText = document.getElementById("topicModalRefText");

  function openTopicModal(id, title) {
    topicModalObjectId.value = id;
    topicInput.value = "";
    topicModalRefText.innerText = title;
    topicModal.showModal();
  }

  function submitTopicCorrection() {
    const id = topicModalObjectId.value;
    const topicLabel = topicInput.value.trim();
    const refText = topicModalRefText.innerText;

    if (!topicLabel) {
      alert("Escribe un tema.");
      return;
    }

    // Construct JSON format expected by Article.topics
    const newValue = [{ label: topicLabel, confidence: "alta" }];

    fetch("/monitor/dashboard/ops/correction/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: JSON.stringify({
        object_id: id,
        model_name: "article",
        correction_type: "topic",
        new_value: newValue,
        reference_text: refText
      })
    })
      .then(res => res.json())
      .then(data => {
        if (data.status === "success") {
          alert("Corrección de tema guardada.");
          topicModal.close();
          window.location.reload();
        } else {
          alert("Error: " + data.error);
        }
      })
      .catch(err => alert("Error de red: " + err));
  }
</script>
{% endblock %}