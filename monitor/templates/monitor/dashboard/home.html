{% extends "monitor/dashboard/base.html" %}
{% block title %}Home · Monitor{% endblock %}
{% block content %}
<div class="page-header">
  <div>
    <h1 class="page-title">Monitor · Centro de cobertura</h1>
    <p class="page-subtitle">Accede a dashboards, comparativos y digests para monitorear cobertura en medios.</p>
  </div>
  <div class="actions">
    <a class="secondary" href="/monitor/dashboard/ingest/">Ingest/Digest</a>
    <a href="/monitor/dashboard/clients/">Clientes</a>
  </div>
</div>

<section class="panel hero">
  <div>
    <h2 class="hero-title">Sigue la conversación pública con atajos a lo esencial.</h2>
    <p class="hero-subtitle">
      Monitor consolida métricas de cobertura, comparativos entre actores y síntesis automáticas.
      Elige una ruta rápida para comenzar a analizar personas, instituciones y temas.
    </p>
    <div class="actions" style="margin-top: 14px;">
      <a class="pill" href="/monitor/dashboard/personas/">Personas</a>
      <a class="pill" href="/monitor/dashboard/instituciones/">Instituciones</a>
      <a class="pill" href="/monitor/dashboard/benchmark/">Benchmark</a>
      <a class="pill" href="/monitor/dashboard/ingest/">Digest</a>
    </div>
  </div>
  <div class="card">
    <h3 class="card-title">Estado del día</h3>
    <p class="card-desc">KPIs clave para entender la producción editorial más reciente.</p>
    <div class="grid grid-3" style="margin-top: 14px;">
      <div>
        <div class="kpi-label">Ingestas OK</div>
        <div class="kpi-value" style="color: var(--primary-soft);">{{ kpis.ingests_ok }}</div>
        <div class="kpi-subtitle">Procesos completados</div>
      </div>
      <div>
        <div class="kpi-label">Artículos hoy</div>
        <div class="kpi-value">{{ kpis.articles_today }}</div>
        <div class="kpi-subtitle">Cobertura diaria</div>
      </div>
      <div>
        <div class="kpi-label">Clusters hoy</div>
        <div class="kpi-value">{{ kpis.clusters_today }}</div>
        <div class="kpi-subtitle">Temas activos</div>
      </div>
    </div>
  </div>
</section>

<section class="panel" style="margin-top: 20px;">
  <h3 class="panel-title">Entrar rápido</h3>
  <p class="panel-subtitle">Explora dashboards por tipo de actor o revisa comparativos listos para presentar.</p>
  <div class="grid grid-3">
    <a class="card card-link" href="/monitor/dashboard/personas/">
      <div class="card-title">Dashboard de personas</div>
      <p class="card-desc">Menciones, medios, sentimiento y temas por actor público.</p>
      <div class="card-meta">Cobertura individual</div>
    </a>
    <a class="card card-link" href="/monitor/dashboard/instituciones/">
      <div class="card-title">Dashboard de instituciones</div>
      <p class="card-desc">Visibilidad institucional con breakdown por medios y temas.</p>
      <div class="card-meta">Cobertura institucional</div>
    </a>
    <a class="card card-link" href="/monitor/dashboard/benchmark/">
      <div class="card-title">Benchmark</div>
      <p class="card-desc">Comparativos rápidos de presencia mediática entre dos actores.</p>
      <div class="card-meta">Comparativos</div>
    </a>
  </div>
</section>

<section class="grid grid-2" style="margin-top: 20px;">
  <div class="card">
    <h3 class="card-title">Digest más reciente</h3>
    <p class="card-desc">Acceso directo a la última síntesis editorial generada.</p>
    <div class="actions" style="margin-top: 12px;">
      {% if digest_latest %}
      <a class="secondary" href="/monitor/dashboard/digests/{{ digest_latest.id }}/">Ver digest último</a>
      {% else %}
      <a class="secondary" href="/monitor/dashboard/ingest/">Generar digest</a>
      {% endif %}
      <a href="/monitor/dashboard/clients/">Configurar alertas</a>
    </div>
  </div>
  <div class="card">
    <h3 class="card-title">Últimas ingestas</h3>
    <p class="card-desc">Revisa ventanas recientes para validar la cobertura incorporada.</p>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Status</th>
          <th>Ventana</th>
        </tr>
      </thead>
      <tbody>
        {% for run in recent_runs %}
        <tr>
          <td>#{{ run.id }}</td>
          <td><span class="tag">{{ run.get_status_display }}</span></td>
          <td>{{ run.time_window_start|date:"d M H:i" }} → {{ run.time_window_end|date:"d M H:i" }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="3" class="table-empty">No hay ingestas recientes.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<section class="card" style="margin-top: 20px;">
  <h3 class="card-title">Últimos Artículos (Corrección Editorial)</h3>
  <p class="card-desc">Corrige temas, sentimiento y clasificación de los artículos recientes.</p>
  <table>
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Medio</th>
        <th>Titular</th>
        <th>Temas</th>
        <th>Sentimiento</th>
        <th>Tipo</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for article in recent_articles %}
      <tr>
        <td>{{ article.published_at|date:"H:i" }}</td>
        <td>{{ article.media_outlet.name }}</td>
        <td>
          <a href="{{ article.url }}" target="_blank" style="color:var(--text); text-decoration:none;">
            {{ article.title|truncatechars:50 }}
          </a>
        </td>
        <td>
          {% for topic in article.topics|slice:":2" %}
          <span class="pill" style="font-size:10px;">{{ topic.label|default:topic }}</span>
          {% endfor %}
        </td>
        <td>
          {% if article.sentiment %}
          {% if article.sentiment.sentiment == "positivo" %}
          <span class="kpi-pill positive" style="font-size:10px;">Positivo</span>
          {% elif article.sentiment.sentiment == "negativo" %}
          <span class="kpi-pill negative" style="font-size:10px;">Negativo</span>
          {% else %}
          <span class="kpi-pill neutral" style="font-size:10px;">Neutro</span>
          {% endif %}
          {% else %}
          <span style="font-size:10px; color:var(--muted);">—</span>
          {% endif %}
        </td>
        <td>
          {% if article.article_type %}
          <span class="pill" style="font-size:10px;">{{ article.article_type|title }}</span>
          {% else %}
          <span style="font-size:10px; color:var(--muted);">—</span>
          {% endif %}
        </td>
        <td>
          <button class="actions ghost" style="padding: 4px 8px; font-size: 12px; cursor: pointer;"
            onclick='openArticleModal("{{ article.id }}", "{{ article.title|escapejs }}", {{ article.topics|default:"[]"|safe }}, "{{ article.sentiment.sentiment|default:"" }}", "{{ article.article_type|default:"" }}")'>
            Corregir
          </button>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="7" class="table-empty">Sin artículos recientes.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>

<!-- Article Correction Modal (Topics, Sentiment, Classification) -->
<dialog id="articleModal"
  style="background: var(--surface); border: 1px solid var(--border); color: var(--text); padding: 20px; border-radius: 12px; max-width: 500px; margin: auto;">
  <form method="dialog">
    <h3 style="margin-top:0;">Corregir Artículo</h3>
    <p id="articleModalRefText" style="font-size: 12px; color: var(--muted); margin-bottom: 16px;"></p>

    <input type="hidden" id="articleModalObjectId">

    <!-- Topics -->
    <label>Temas (separados por comas):</label>
    <input type="text" id="articleTopicInput" placeholder="Ej: Política, Seguridad, Economía..."
      style="margin-bottom: 8px;">
    <div style="font-size: 11px; color: var(--muted); margin-bottom: 16px;">
      Escribe varios temas separados por comas.
    </div>

    <!-- Sentiment -->
    <label>Sentimiento:</label>
    <select id="articleSentimentSelect" style="margin-bottom: 16px;">
      <option value="">Sin clasificar</option>
      <option value="positivo">Positivo</option>
      <option value="neutro">Neutro</option>
      <option value="negativo">Negativo</option>
    </select>

    <!-- Article Type (Información vs Opinión) -->
    <label>Clasificación:</label>
    <select id="articleTypeSelect" style="margin-bottom: 16px;">
      <option value="">Sin clasificar</option>
      <option value="informacion">Información</option>
      <option value="opinion">Opinión</option>
    </select>

    <!-- Personas Mencionadas -->
    <label>Personas Mencionadas:</label>
    <select id="articlePersonasSelect" multiple style="margin-bottom: 8px; height: 120px;">
      {% for persona in all_personas %}
      <option value="{{ persona.id }}">{{ persona.nombre_completo }}</option>
      {% endfor %}
    </select>
    <div style="font-size: 11px; color: var(--muted); margin-bottom: 16px;">
      Mantén presionado Ctrl (Cmd en Mac) para seleccionar varias personas.
    </div>

    <div class="actions" style="justify-content: flex-end;">
      <button value="cancel" class="ghost" type="button"
        onclick="document.getElementById('articleModal').close()">Cancelar</button>
      <button type="button" onclick="submitArticleCorrection()" style="background: var(--primary);">Guardar
        Correcciones</button>
    </div>
  </form>
</dialog>

<script>
  const articleModal = document.getElementById("articleModal");
  const articleModalObjectId = document.getElementById("articleModalObjectId");
  const articleTopicInput = document.getElementById("articleTopicInput");
  const articleSentimentSelect = document.getElementById("articleSentimentSelect");
  const articleTypeSelect = document.getElementById("articleTypeSelect");
  const articlePersonasSelect = document.getElementById("articlePersonasSelect");
  const articleModalRefText = document.getElementById("articleModalRefText");

  function openArticleModal(id, title, topicsJson, sentiment, articleType) {
    articleModalObjectId.value = id;
    articleModalRefText.innerText = title;

    // Parse and populate topics
    try {
      const topics = typeof topicsJson === 'string' ? JSON.parse(topicsJson) : (topicsJson || []);
      const topicLabels = topics.map(t => t.label || t).join(', ');
      articleTopicInput.value = topicLabels;
    } catch (e) {
      console.error("Error parsing topics:", e);
      articleTopicInput.value = "";
    }

    // Populate sentiment
    articleSentimentSelect.value = sentiment || "";

    // Populate article type
    articleTypeSelect.value = articleType || "";

    // Clear personas selection
    for (let option of articlePersonasSelect.options) {
      option.selected = false;
    }

    articleModal.showModal();
  }

  function submitArticleCorrection() {
    const id = articleModalObjectId.value;
    const topicInputValue = articleTopicInput.value.trim();
    const sentiment = articleSentimentSelect.value;
    const articleType = articleTypeSelect.value;
    const refText = articleModalRefText.innerText;

    // Get selected personas
    const selectedPersonas = Array.from(articlePersonasSelect.selectedOptions).map(opt => opt.value);

    const topics = topicInputValue.split(',').map(t => t.trim()).filter(t => t.length > 0).map(label => ({ label, confidence: "alta" }));

    if (topics.length > 0) submitCorrection(id, "topic", topics, refText);
    if (sentiment) submitCorrection(id, "sentiment_article", sentiment, refText);
    if (articleType) submitCorrection(id, "article_type", articleType, refText);
    if (selectedPersonas.length > 0) submitCorrection(id, "article_personas", selectedPersonas, refText);

    setTimeout(() => {
      alert("Correcciones guardadas.");
      articleModal.close();
      window.location.reload();
    }, 500);
  }

  function submitCorrection(id, correctionType, newValue, refText) {

    fetch("/monitor/dashboard/ops/correction/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: JSON.stringify({
        object_id: id,
        model_name: "article",
        correction_type: correctionType,
        new_value: newValue,
        reference_text: refText
      })
    })
      .then(res => res.json())
      .then(data => {
        if (data.status !== "success") console.error("Error:", data.error);
      })
      .catch(err => console.error("Error:", err));
  }
</script>
{% endblock %}