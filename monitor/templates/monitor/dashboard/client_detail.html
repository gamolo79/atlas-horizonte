{% extends "monitor/dashboard/base.html" %}
{% block title %}Cliente: {{ client.name }} · Monitor{% endblock %}
{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">{{ client.name }}</h1>
        <p class="page-subtitle">Configuración de entidades de interés.</p>
    </div>
    <div class="actions">
        <a class="secondary" href="{% url 'monitor_dashboard_client_list' %}">Volver</a>
    </div>
</div>

<section class="grid grid-2">
    <div class="card">
        <h3 class="card-title">Focos de monitoreo</h3>
        <p class="card-desc">Entidades prioritarias para la síntesis diaria.</p>
        <table class="table-compact">
            <thead>
                <tr>
                    <th>Prioridad</th>
                    <th>Tipo</th>
                    <th>Nombre</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for item in focus_items %}
                <tr>
                    <td>{{ item.priority }}</td>
                    <td>{{ item.type|title }}</td>
                    <td>{{ item.name }}</td>
                    <td>
                        <form method="post" style="margin: 0;">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="remove_focus">
                            <input type="hidden" name="focus_id" value="{{ item.id }}">
                            <div class="actions">
                                <button type="submit" class="danger" onclick="return confirm('¿Eliminar este foco?')">
                                    Eliminar
                                </button>
                            </div>
                        </form>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" class="table-empty">Sin focos configurados.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="card">
        <h3 class="card-title">Añadir nuevo foco</h3>
        <p class="card-desc">Define personas, instituciones o temas a priorizar.</p>
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="add_focus">

            <label>Tipo</label>
            <select id="add_type" name="entity_type" onchange="toggleAddSelect()">
                <option value="persona">Persona</option>
                <option value="institucion">Institución</option>
                <option value="tema">Tema</option>
            </select>

            <div id="add_persona_div" style="margin-top: 12px;">
                <label>Persona</label>
                <select name="entity_id" id="add_persona_sel">
                    {% for p in personas %}
                    <option value="{{ p.id }}">{{ p.nombre_completo }}</option>
                    {% endfor %}
                </select>
            </div>

            <div id="add_inst_div" style="display:none; margin-top: 12px;">
                <label>Institución</label>
                <select name="entity_id_inst" id="add_inst_sel" disabled>
                    {% for i in instituciones %}
                    <option value="{{ i.id }}">{{ i.nombre }}</option>
                    {% endfor %}
                </select>
            </div>

            <div id="add_tema_div" style="display:none; margin-top: 12px;">
                <label>Tema</label>
                <select name="entity_id_tema" id="add_tema_sel" disabled>
                    {% for t in temas %}
                    <option value="{{ t.id }}">{{ t.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <label style="margin-top: 12px;">Prioridad</label>
            <select name="priority">
                <option value="1">1 - Alta</option>
                <option value="2">2 - Media</option>
                <option value="3">3 - Baja</option>
            </select>

            <div class="actions" style="justify-content: flex-end; margin-top: 16px;">
                <button type="submit">Añadir</button>
            </div>
        </form>
    </div>
</section>

<script>
    function toggleAddSelect() {
        const type = document.getElementById('add_type').value;
        const pDiv = document.getElementById('add_persona_div');
        const iDiv = document.getElementById('add_inst_div');
        const tDiv = document.getElementById('add_tema_div');
        const pSel = document.getElementById('add_persona_sel');
        const iSel = document.getElementById('add_inst_sel');
        const tSel = document.getElementById('add_tema_sel');

        if (type === 'persona') {
            pDiv.style.display = 'block';
            iDiv.style.display = 'none';
            tDiv.style.display = 'none';
            pSel.name = 'entity_id';
            pSel.disabled = false;
            iSel.name = '';
            iSel.disabled = true;
            tSel.name = '';
            tSel.disabled = true;
        } else if (type === 'institucion') {
            pDiv.style.display = 'none';
            iDiv.style.display = 'block';
            tDiv.style.display = 'none';
            pSel.name = '';
            pSel.disabled = true;
            iSel.name = 'entity_id_inst';
            iSel.disabled = false;
            tSel.name = '';
            tSel.disabled = true;
        } else {
            pDiv.style.display = 'none';
            iDiv.style.display = 'none';
            tDiv.style.display = 'block';
            pSel.name = '';
            pSel.disabled = true;
            iSel.name = '';
            iSel.disabled = true;
            tSel.name = 'entity_id_tema';
            tSel.disabled = false;
        }
    }
</script>
{% endblock %}
