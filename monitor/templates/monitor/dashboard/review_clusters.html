{% extends "monitor/dashboard/base.html" %}
{% block title %}Revisión de Clusters · Monitor{% endblock %}
{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Revisión de Clusters</h1>
        <p class="page-subtitle">Últimas historias ({{ since|date:"d M H:i" }} - ahora).</p>
    </div>
    <div class="actions">
        <a class="secondary" href="{% url 'monitor_dashboard_ops' %}">Volver a Ops</a>
    </div>
</div>

<section class="card">
    <h3 class="card-title">Historias Recientes ({{ stories|length }})</h3>
    <p class="card-desc">Revisa la agrupación automática de historias.</p>

    {% for story in stories %}
    <div class="card" style="margin-top: 16px; background: rgba(15, 23, 42, 0.4);">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
            <div>
                <h4 style="margin: 0; font-size: 16px;">
                    <span class="tag" style="margin-right: 8px;">#{{ story.id }}</span>
                    {{ story.title_base|truncatechars:100 }}
                </h4>
                <div style="margin-top: 6px; font-size: 12px; color: var(--muted);">
                    {{ story.time_window_start|date:"d M, H:i" }} · {{ story.story_articles.all|length }} artículos
                </div>
            </div>
            <div class="actions">
                <button class="ghost" style="padding: 4px 8px; font-size: 12px;"
                    onclick="toggleCluster('story-{{ story.id }}')">
                    Ver artículos
                </button>
            </div>
        </div>

        <div id="story-{{ story.id }}" style="display: none; margin-top: 12px;">
            <table style="width: 100%; font-size: 13px;">
                <thead>
                    <tr>
                        <th>Titular</th>
                        <th>Medio</th>
                        <th>Confianza (IA)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sa in story.story_articles.all %}
                    <tr>
                        <td>
                            <a href="{{ sa.article.url }}" target="_blank"
                                style="color:var(--text); text-decoration:none;">
                                {{ sa.article.title|truncatechars:80 }}
                            </a>
                            {% if sa.is_representative %}
                            <span class="tag" style="font-size: 10px; margin-left: 6px;">REP</span>
                            {% endif %}
                        </td>
                        <td>{{ sa.article.outlet }}</td>
                        <td>{{ sa.confidence|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <!-- Correction actions could go here (remove article, etc) -->
        </div>
    </div>
    {% empty %}
    <p class="muted">No hay historias recientes.</p>
    {% endfor %}
</section>

<script>
    function toggleCluster(id) {
        const elem = document.getElementById(id);
        if (elem.style.display === 'none') {
            elem.style.display = 'block';
        } else {
            elem.style.display = 'none';
        }
    }
</script>
{% endblock %}
