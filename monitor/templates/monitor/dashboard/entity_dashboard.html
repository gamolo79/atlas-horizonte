{% extends "monitor/dashboard/base.html" %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">{{ entity }}</h1>
        <p class="page-subtitle">Cobertura editorial para los últimos {{ days }} días.</p>
    </div>
    <div class="actions">
        <a class="secondary" href="?days=7">7 días</a>
        <a class="secondary" href="?days=30">30 días</a>
        <a class="secondary" href="?days=90">90 días</a>
    </div>
</div>

<section class="grid grid-3">
    <div class="card chart-card">
        <div class="chart-header">
            <h3 class="chart-title">Volumen de menciones</h3>
            <div class="chart-subtitle">Evolución diaria de menciones y cobertura.</div>
        </div>
        <div class="chart-container">
            <canvas id="volumeChart" aria-label="Volumen de menciones" role="img"></canvas>
        </div>
    </div>
    <div class="card chart-card">
        <div class="chart-header">
            <h3 class="chart-title">Sentimiento agregado</h3>
            <div class="chart-subtitle">Balance de tono por actor.</div>
        </div>
        <div class="chart-container">
            <canvas id="sentimentChart" aria-label="Sentimiento" role="img"></canvas>
        </div>
    </div>
    <div class="card">
        <h3 class="card-title">Historias recientes</h3>
        <p class="card-desc">Clusters editoriales donde aparece el actor.</p>
        <ul class="digest-body" style="margin: 0;">
            {% for story in recent_stories %}
            <li style="margin-bottom: 10px;">
                <strong>{{ story.title_base|default:"Historia sin título" }}</strong>
                <div class="muted small">{{ story.time_window_start|date:"d M H:i" }}</div>
            </li>
            {% empty %}
            <li class="muted small">Sin historias agrupadas recientemente.</li>
            {% endfor %}
        </ul>
    </div>
</section>

<section class="card" style="margin-top: 24px;">
    <h3 class="card-title">Menciones recientes (transparencia editorial)</h3>
    <p class="card-desc">Revisión rápida para corrección y entrenamiento supervisado.</p>
    <table class="table-compact">
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Medio</th>
                <th>Título</th>
                <th>Sentimiento</th>
                <th>Acción</th>
            </tr>
        </thead>
        <tbody>
            {% for link in recent_links %}
            <tr>
                <td>{{ link.article.published_at|date:"Y-m-d" }}</td>
                <td>{{ link.article.outlet }}</td>
                <td>
                    <a href="{{ link.article.url }}" target="_blank" style="color: inherit; text-decoration: none;">
                        {{ link.article.title|truncatechars:60 }}
                    </a>
                </td>
                <td>
                    <span class="badge {% if link.sentiment == 'positivo' %}success{% elif link.sentiment == 'negativo' %}danger{% else %}neutral{% endif %}">
                        {{ link.sentiment }}
                    </span>
                    <span class="muted small">({{ link.sentiment_confidence|floatformat:2 }})</span>
                </td>
                <td>
                    <div class="actions">
                        <button class="ghost" style="padding: 4px 8px; font-size: 12px;"
                            data-id="{{ link.id }}" data-current="{{ link.sentiment }}" onclick="correctSentiment(this)">
                            Corregir
                        </button>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5" class="table-empty">Sin menciones recientes.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</section>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const dates = JSON.parse('{{ chart_data.dates|safe }}');
    const volumes = JSON.parse('{{ chart_data.volumes|safe }}');
    const sentiments = JSON.parse('{{ chart_data.sentiments|safe }}');

    new Chart(document.getElementById("volumeChart"), {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: "Menciones",
                data: volumes,
                borderColor: "#22c55e",
                backgroundColor: "rgba(34, 197, 94, 0.2)",
                fill: true,
                tension: 0.35
            }]
        },
        options: {
            maintainAspectRatio: false,
            scales: {
                x: { ticks: { color: "#cbd5f5" }, grid: { color: "rgba(148, 163, 184, 0.15)" } },
                y: { ticks: { color: "#cbd5f5" }, grid: { color: "rgba(148, 163, 184, 0.15)" } },
            },
            plugins: {
                legend: { labels: { color: "#e2e8f0" } },
            }
        }
    });

    const sentTotals = [
        sentiments.pos.reduce((a, b) => a + b, 0),
        sentiments.neu.reduce((a, b) => a + b, 0),
        sentiments.neg.reduce((a, b) => a + b, 0)
    ];

    new Chart(document.getElementById("sentimentChart"), {
        type: 'doughnut',
        data: {
            labels: ["Positivo", "Neutro", "Negativo"],
            datasets: [{
                data: sentTotals,
                backgroundColor: ['#22c55e', '#94a3b8', '#ef4444'],
            }]
        },
        options: {
            maintainAspectRatio: false,
            plugins: {
                legend: { labels: { color: "#e2e8f0" } },
            }
        }
    });

    function correctSentiment(btn) {
        const linkId = btn.dataset.id;
        const current = btn.dataset.current;
        const newValue = prompt("Nuevo sentimiento (positivo, neutro, negativo):", current);

        if (newValue && ['positivo', 'neutro', 'negativo'].includes(newValue.toLowerCase())) {
            fetch("{% url 'monitor_api_correct_link' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    link_id: linkId,
                    action: "sentiment",
                    value: newValue.toLowerCase()
                })
            }).then(res => res.json()).then(data => {
                if (data.status === "ok") {
                    location.reload();
                } else {
                    alert("Error: " + data.message);
                }
            });
        }
    }
</script>
{% endblock %}
