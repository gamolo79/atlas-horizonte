{% extends "monitor/dashboard/base.html" %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Entrenamiento editorial</h1>
        <p class="page-subtitle">Correcciones supervisadas para ajustar sentimiento y vínculos.</p>
    </div>
</div>

<section class="card">
    <h3 class="card-title">Menciones recientes</h3>
    <p class="card-desc">Selecciona y corrige menciones para mejorar la IA.</p>
    <table class="table-compact">
        <thead>
            <tr>
                <th>Artículo</th>
                <th>Entidad detectada</th>
                <th>Rol</th>
                <th>Sentimiento</th>
                <th>Confianza</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for link in links %}
            <tr>
                <td>
                    <a href="{{ link.article.url }}" target="_blank" title="{{ link.article.title }}"
                        style="color: inherit; text-decoration: none;">
                        {{ link.article.outlet }}
                    </a>
                </td>
                <td>{{ link.atlas_entity_id }} ({{ link.atlas_entity_type }})</td>
                <td>{{ link.role_in_article }}</td>
                <td>
                    <span class="badge {% if link.sentiment == 'positivo' %}success{% elif link.sentiment == 'negativo' %}danger{% else %}neutral{% endif %}">
                        {{ link.sentiment }}
                    </span>
                </td>
                <td>{{ link.sentiment_confidence|floatformat:2 }}</td>
                <td>
                    <div class="actions">
                        <button class="ghost" style="padding: 4px 8px; font-size: 12px;"
                            onclick="correctLink({{ link.id }}, '{{ link.sentiment }}')">
                            Corregir
                        </button>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" class="table-empty">No hay menciones recientes.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</section>

<script>
    function correctLink(id, currentSentiment) {
        const newVal = prompt("Nuevo sentimiento (positivo, neutro, negativo):", currentSentiment);
        if (newVal) {
            // Call API
            fetch("{% url 'monitor_api_correct_link' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ link_id: id, action: "sentiment", value: newVal })
            }).then(res => res.json()).then(data => {
                if (data.status === "ok") location.reload();
                else alert("Error: " + data.message);
            });
        }
    }
</script>
{% endblock %}
