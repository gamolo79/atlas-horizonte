{% extends "monitor/dashboard/base.html" %}
{% block title %}{{ institucion.nombre }} · Monitor{% endblock %}
{% block content %}
  <div class="page-header">
    <div>
      <h1 class="page-title">{{ institucion.nombre }}</h1>
      <p class="muted">Resumen de cobertura en los últimos {{ days }} días.</p>
    </div>
    <div class="actions">
      <a class="secondary" href="/monitor/dashboard/instituciones/benchmark/?a={{ institucion.id }}">Comparar</a>
      <a href="/monitor/dashboard/instituciones/">Volver</a>
    </div>
  </div>

  <section class="grid grid-3">
    <div class="card">
      <div class="muted">Menciones</div>
      <div class="kpi">{{ metrics.mentions_count }}</div>
    </div>
    <div class="card">
      <div class="muted">Artículos únicos</div>
      <div class="kpi">{{ metrics.articles_count }}</div>
    </div>
    <div class="card">
      <div class="muted">Sentimientos</div>
      <div class="kpi">{{ metrics.sentiment_summary|length }}</div>
    </div>
  </section>

  <section class="grid" style="margin-top: 20px;">
    <div class="card chart-card">
      <div class="chart-header">
        <h3 class="chart-title">Sentimiento</h3>
        <div class="chart-subtitle">Distribución del tono editorial.</div>
      </div>
      <div class="chart-container">
        <canvas id="institucionSentimentChart" aria-label="Distribución de sentimiento" role="img"></canvas>
      </div>
    </div>
    <div class="card chart-card">
      <div class="chart-header">
        <h3 class="chart-title">Top medios</h3>
        <div class="chart-subtitle">Menciones por outlet.</div>
      </div>
      <div class="chart-container">
        <canvas id="institucionOutletsChart" aria-label="Top medios" role="img"></canvas>
      </div>
    </div>
    <div class="card chart-card">
      <div class="chart-header">
        <h3 class="chart-title">Clusters destacados</h3>
        <div class="chart-subtitle">Actividad por cluster.</div>
      </div>
      <div class="chart-container">
        <canvas id="institucionClustersChart" aria-label="Clusters destacados" role="img"></canvas>
      </div>
    </div>
  </section>

  <section class="grid grid-2" style="margin-top: 20px;">
    <div class="card">
      <h3>Top medios</h3>
      <table>
        <thead>
          <tr>
            <th>Medio</th>
            <th>Menciones</th>
          </tr>
        </thead>
        <tbody>
          {% for outlet in metrics.outlets %}
            <tr>
              <td>{{ outlet.name }}</td>
              <td>{{ outlet.total }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="2" class="table-empty">Sin datos de medios.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="card">
      <h3>Clusters destacados</h3>
      <table>
        <thead>
          <tr>
            <th>Titular</th>
            <th>Actividad</th>
          </tr>
        </thead>
        <tbody>
          {% for cluster in metrics.clusters %}
            <tr>
              <td>{{ cluster.headline|truncatechars:80 }}</td>
              <td>{{ cluster.total }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="2" class="table-empty">Sin clusters recientes.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
{% endblock %}

{% block extra_scripts %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    const sentimentLabels = [{% for label, total in metrics.sentiment_summary.items %}"{{ label|title|escapejs }}",{% endfor %}];
    const sentimentValues = [{% for label, total in metrics.sentiment_summary.items %}{{ total }},{% endfor %}];
    const outletLabels = [{% for outlet in metrics.outlets %}"{{ outlet.name|escapejs }}",{% endfor %}];
    const outletValues = [{% for outlet in metrics.outlets %}{{ outlet.total }},{% endfor %}];
    const clusterLabels = [{% for cluster in metrics.clusters %}"{{ cluster.headline|truncatechars:28|escapejs }}",{% endfor %}];
    const clusterValues = [{% for cluster in metrics.clusters %}{{ cluster.total }},{% endfor %}];

    new Chart(document.getElementById("institucionSentimentChart"), {
      type: "doughnut",
      data: {
        labels: sentimentLabels.length ? sentimentLabels : ["Sin datos"],
        datasets: [{
          data: sentimentValues.length ? sentimentValues : [1],
          backgroundColor: ["#22c55e", "#f97316", "#ef4444", "#38bdf8", "#a855f7"],
          borderColor: "#0f172a",
        }],
      },
      options: {
        plugins: {
          legend: { labels: { color: "#e2e8f0" } },
        },
      },
    });

    new Chart(document.getElementById("institucionOutletsChart"), {
      type: "bar",
      data: {
        labels: outletLabels,
        datasets: [{
          label: "Menciones",
          data: outletValues,
          backgroundColor: "rgba(34, 197, 94, 0.7)",
        }],
      },
      options: {
        scales: {
          x: { ticks: { color: "#cbd5f5" } },
          y: { ticks: { color: "#cbd5f5" } },
        },
        plugins: {
          legend: { labels: { color: "#e2e8f0" } },
        },
      },
    });

    new Chart(document.getElementById("institucionClustersChart"), {
      type: "bar",
      data: {
        labels: clusterLabels,
        datasets: [{
          label: "Actividad",
          data: clusterValues,
          backgroundColor: "rgba(56, 189, 248, 0.7)",
        }],
      },
      options: {
        scales: {
          x: { ticks: { color: "#cbd5f5" } },
          y: { ticks: { color: "#cbd5f5" } },
        },
        plugins: {
          legend: { labels: { color: "#e2e8f0" } },
        },
      },
    });
  </script>
{% endblock %}
