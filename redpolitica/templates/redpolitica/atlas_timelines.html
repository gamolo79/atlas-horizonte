{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Atlas · Timelines</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/atlas-design-system.css' %}">
</head>
<body class="timeline-body">
  <div class="page">
    <header>
      <div class="header-inner">
        <div class="header-row">
          <a class="brand" href="{% url 'atlas-home' %}">
            <img src="{% static 'img/logo-horizonte-atlas.png' %}" alt="Atlas" class="brand-logo">
            <div class="brand-texts">
              <div class="brand-text-main">Atlas · Timelines</div>
              <div class="brand-text-sub">Personas e instituciones</div>
            </div>
          </a>
        </div>
        <div class="header-row header-row-nav">
          <nav class="chips-row" aria-label="Navegación de Atlas">
            <a class="chip-link" href="{% url 'atlas-home' %}">Home</a>
            <a class="chip-link" href="{% url 'atlas-personas-list' %}">Personas</a>
            <a class="chip-link" href="{% url 'atlas-instituciones-list' %}">Instituciones</a>
            <a class="chip-link" href="{% url 'atlas-topics-list' %}">Temas</a>
            <a class="chip-link" href="javascript:history.back()">Regresar</a>
          </nav>
        </div>
      </div>
    </header>

    <main>
      <div class="main-inner">
        <div class="timeline-app">
          <div class="timeline-topbar">
            <div class="timeline-brand">
              <div class="timeline-logo"></div>
              <div>
                <h1>Atlas · Timelines</h1>
                <p>Explora periodos y cargos por actor</p>
              </div>
            </div>

            <div class="timeline-filters">
              <div class="timeline-field">
                <label for="entityType">Entidad</label>
                <select id="entityType">
                  <option value="persona">Persona</option>
                  <option value="institucion">Institución</option>
                </select>
              </div>

              <div class="timeline-field">
                <label for="entitySelect">Selecciona</label>
                <select id="entitySelect"></select>
              </div>

              <button class="timeline-btn" id="btnToday">Ir a hoy</button>
            </div>
          </div>

          <div class="timeline-panel">
            <div class="timeline-panel-header">
              <div class="timeline-titleblock">
                <h2 id="headline">Timeline</h2>
                <div class="timeline-meta">
                  <span class="timeline-chip"><span class="timeline-dot"></span><span id="subhead">Selecciona una entidad para ver cargos por periodo</span></span>
                  <span class="timeline-chip">Eje: años + 12 meses</span>
                  <span class="timeline-chip">Empalmes: apilado vertical</span>
                </div>
              </div>

              <div class="timeline-legend">
                <span class="timeline-swatch"><i style="background:#7aa2ff"></i> Federal</span>
                <span class="timeline-swatch"><i style="background:#6ee7b7"></i> Estatal</span>
                <span class="timeline-swatch"><i style="background:#fbbf24"></i> Municipal</span>
                <span class="timeline-swatch"><i style="background:#c084fc"></i> Partidista</span>
                <span class="timeline-swatch"><i style="background:#94a3b8"></i> Otro</span>
              </div>
            </div>

            <div class="timeline-wrap">
              <div class="timeline-scroller" id="scroller">
                <div class="timeline-canvas" id="canvas">
                  <div class="timeline-grid" id="grid"></div>
                  <div class="timeline-rows" id="rows"></div>
                </div>
              </div>
              <div class="timeline-footer-note">
                Tip: pasa el mouse sobre una barra para ver el tooltip. En móvil, toca una barra.
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer>
      Horizonte Digital · Atlas · <a href="{% url 'privacy-notice' %}">Aviso de privacidad</a> · <a href="{% url 'terms-conditions' %}">Términos y condiciones</a>
    </footer>
  </div>

  <div class="timeline-tooltip" id="tooltip" role="tooltip" aria-hidden="true"></div>

  {{ timeline_data|json_script:"timeline-data" }}

  <script>
    const dataScript = document.getElementById("timeline-data");
    const DATA = dataScript ? (JSON.parse(dataScript.textContent) || {}) : {};
    const PERSONAS = Array.isArray(DATA.personas) ? DATA.personas : [];
    const INSTITUCIONES = Array.isArray(DATA.instituciones) ? DATA.instituciones : [];

    const START_YEAR_DEFAULT = 1997;
    const END_YEAR_DEFAULT = new Date().getFullYear();
    let currentStartYear = START_YEAR_DEFAULT;
    let currentEndYear = END_YEAR_DEFAULT;

    const levelColor = {
      federal: "linear-gradient(135deg, rgba(122,162,255,.85), rgba(122,162,255,.55))",
      estatal: "linear-gradient(135deg, rgba(110,231,183,.85), rgba(110,231,183,.55))",
      municipal: "linear-gradient(135deg, rgba(251,191,36,.85), rgba(251,191,36,.55))",
      partidista: "linear-gradient(135deg, rgba(192,132,252,.85), rgba(192,132,252,.55))",
      otro: "linear-gradient(135deg, rgba(148,163,184,.65), rgba(148,163,184,.35))",
    };

    const entityType = document.getElementById("entityType");
    const entitySelect = document.getElementById("entitySelect");
    const headline = document.getElementById("headline");
    const subhead = document.getElementById("subhead");
    const grid = document.getElementById("grid");
    const rows = document.getElementById("rows");
    const canvas = document.getElementById("canvas");
    const scroller = document.getElementById("scroller");
    const tooltip = document.getElementById("tooltip");
    document.getElementById("btnToday").addEventListener("click", scrollToToday);

    function parseDate(s) {
      const [y, m, d] = s.split("-").map(Number);
      return new Date(y, m - 1, d || 1);
    }

    function formatMY(s) {
      const d = parseDate(s);
      const months = ["ene", "feb", "mar", "abr", "may", "jun", "jul", "ago", "sep", "oct", "nov", "dic"];
      return `${months[d.getMonth()]} ${d.getFullYear()}`;
    }

    function getTimelineBounds(items) {
      let startYear = START_YEAR_DEFAULT;
      let endYear = END_YEAR_DEFAULT;
      if (!items.length) {
        return { startYear, endYear };
      }
      let minYear = endYear;
      let maxYear = startYear;
      items.forEach((it) => {
        const start = parseDate(it.inicio).getFullYear();
        const end = parseDate(it.fin).getFullYear();
        minYear = Math.min(minYear, start);
        maxYear = Math.max(maxYear, end);
      });
      startYear = Math.min(startYear, minYear);
      endYear = Math.max(endYear, maxYear);
      return { startYear, endYear };
    }

    function monthIndex(d, startYear) {
      return (d.getFullYear() - startYear) * 12 + d.getMonth();
    }

    function totalMonths(startYear, endYear) {
      return (endYear - startYear + 1) * 12;
    }

    function getMonthWidth() {
      const styles = getComputedStyle(canvas);
      const value = parseFloat(styles.getPropertyValue("--month-width"));
      return Number.isFinite(value) ? value : 18;
    }

    function setCanvasWidth(startYear, endYear) {
      const w = totalMonths(startYear, endYear) * getMonthWidth() + 20;
      canvas.style.width = `${w}px`;
    }

    function buildGrid(startYear, endYear) {
      grid.innerHTML = "";
      setCanvasWidth(startYear, endYear);

      const yearRow = document.createElement("div");
      yearRow.className = "timeline-year-row";
      yearRow.innerHTML = `<span>${startYear} → ${endYear}</span>`;
      grid.appendChild(yearRow);

      const months = totalMonths(startYear, endYear);
      const monthPx = getMonthWidth();
      for (let i = 0; i <= months; i++) {
        const x = 10 + i * monthPx;
        const isYear = i % 12 === 0;

        const line = document.createElement("div");
        line.className = isYear ? "timeline-year-line" : "timeline-month-line";
        line.style.left = `${x}px`;
        grid.appendChild(line);
      }

      for (let y = startYear; y <= endYear; y++) {
        const i = (y - startYear) * 12;
        const x = 10 + i * monthPx;
        const lab = document.createElement("div");
        lab.className = "timeline-year-label";
        lab.style.left = `${x + 6}px`;
        lab.textContent = String(y);
        grid.appendChild(lab);
      }
    }

    function stackOverlaps(items, startYear) {
      const segs = items
        .map((it) => {
          const s = parseDate(it.inicio);
          const e = parseDate(it.fin);
          const start = monthIndex(s, startYear);
          const end = monthIndex(e, startYear);
          return { ...it, _start: start, _end: end };
        })
        .sort((a, b) => a._start - b._start || a._end - b._end);

      const rowsEnd = [];
      for (const it of segs) {
        let placed = false;
        for (let r = 0; r < rowsEnd.length; r++) {
          if (it._start > rowsEnd[r]) {
            it._row = r;
            rowsEnd[r] = it._end;
            placed = true;
            break;
          }
        }
        if (!placed) {
          it._row = rowsEnd.length;
          rowsEnd.push(it._end);
        }
      }
      return { segs, rowCount: rowsEnd.length };
    }

    function clearTimeline() {
      rows.innerHTML = "";
      tooltip.classList.remove("show");
      tooltip.setAttribute("aria-hidden", "true");
    }

    function renderEmpty(message) {
      const empty = document.createElement("div");
      empty.className = "timeline-empty";
      empty.innerHTML = `<strong>Sin datos</strong><span>${message}</span>`;
      rows.appendChild(empty);
    }

    function renderLane(title, subtitle, items, mode, startYear) {
      const lane = document.createElement("div");
      lane.className = "timeline-lane";

      const laneTitle = document.createElement("div");
      laneTitle.className = "timeline-lane-title";
      laneTitle.innerHTML = `<strong>${title}</strong><small>${subtitle}</small>`;
      lane.appendChild(laneTitle);

      const barsWrap = document.createElement("div");
      barsWrap.className = "timeline-bars";
      lane.appendChild(barsWrap);

      const { segs, rowCount } = stackOverlaps(items, startYear);
      barsWrap.style.setProperty("--bar-rows", rowCount || 1);

      const monthPx = getMonthWidth();
      for (const it of segs) {
        const startX = 10 + it._start * monthPx;
        const endX = 10 + (it._end + 1) * monthPx;
        const w = Math.max(monthPx, endX - startX - 2);

        const bar = document.createElement("div");
        bar.className = "timeline-bar";
        bar.style.left = `${startX}px`;
        bar.style.width = `${w}px`;
        bar.style.background = levelColor[it.nivel] || levelColor.otro;
        bar.style.setProperty("--row-index", it._row);

        const main = mode === "persona" ? `${it.label}` : `${it.persona}`;
        const sub = mode === "persona" ? `${it.institucion}` : `${it.label} · ${it.persona}`;

        bar.innerHTML = `
          <span class="bar-tag">${it.nivel}</span>
          <div class="bar-text">
            <b title="${main}">${main}</b>
            <span title="${sub}">${sub}</span>
          </div>
        `;

        const tooltipTitle = mode === "persona" ? `${it.label}` : `${it.persona}`;
        const tooltipSub = mode === "persona" ? `${it.institucion}` : `${it.label}`;
        const temas = Array.isArray(it.temas) ? it.temas : [];

        bar.addEventListener("mouseenter", (ev) =>
          showTip(ev, tooltipTitle, tooltipSub, it.nivel, it.inicio, it.fin, temas)
        );
        bar.addEventListener("mousemove", (ev) => moveTip(ev));
        bar.addEventListener("mouseleave", hideTip);

        bar.addEventListener("click", (ev) => {
          showTip(ev, tooltipTitle, tooltipSub, it.nivel, it.inicio, it.fin, temas);
          if (window.matchMedia("(max-width: 720px)").matches) {
            setTimeout(hideTip, 1800);
          }
        });

        barsWrap.appendChild(bar);
      }

      rows.appendChild(lane);
    }

    function showTip(ev, title, sub, nivel, inicio, fin, temas) {
      const topicsHtml = (temas && temas.length)
        ? `
          <div class="tooltip-topics">
            <div class="tooltip-topics-title">Temas</div>
            <div class="tooltip-meta">
              ${temas.map((tema) => `<span class="tooltip-pill">${escapeHtml(tema)}</span>`).join("")}
            </div>
          </div>
        `
        : `
          <div class="tooltip-topics">
            <div class="tooltip-topics-title">Temas</div>
            <div class="tooltip-empty">Sin temas vinculados</div>
          </div>
        `;

      tooltip.innerHTML = `
        <div class="tooltip-title">${escapeHtml(title)}</div>
        <div class="tooltip-subtitle">${escapeHtml(sub)}</div>
        <div class="tooltip-meta">
          <span class="tooltip-pill">${escapeHtml(nivel)}</span>
          <span class="tooltip-pill">${formatMY(inicio)} – ${formatMY(fin)}</span>
        </div>
        ${topicsHtml}
      `;
      tooltip.classList.add("show");
      tooltip.setAttribute("aria-hidden", "false");
      moveTip(ev);
    }

    function moveTip(ev) {
      tooltip.style.left = `${ev.clientX + 12}px`;
      tooltip.style.top = `${ev.clientY + 12}px`;
    }

    function hideTip() {
      tooltip.classList.remove("show");
      tooltip.setAttribute("aria-hidden", "true");
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, (c) => (
        { "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;" }[c]
      ));
    }

    function renderTimeline() {
      clearTimeline();

      const type = entityType.value;
      const id = entitySelect.value;
      const list = type === "persona" ? PERSONAS : INSTITUCIONES;
      const selected = list.find((item) => String(item.id) === String(id));

      if (!selected) {
        headline.textContent = "Timeline";
        subhead.textContent = "Selecciona una entidad para ver cargos por periodo";
        renderEmpty("Selecciona una entidad para visualizar sus periodos.");
        currentStartYear = START_YEAR_DEFAULT;
        currentEndYear = END_YEAR_DEFAULT;
        buildGrid(currentStartYear, currentEndYear);
        return;
      }

      if (type === "persona") {
        headline.textContent = `Timeline · ${selected.nombre}`;
        subhead.textContent = "Cargos ocupados (apilado cuando hay empalmes)";
      } else {
        headline.textContent = `Timeline · ${selected.nombre}`;
        subhead.textContent = "Personas y cargos por periodo dentro de la institución";
      }

      const items = selected.cargos || [];
      const { startYear, endYear } = getTimelineBounds(items);
      currentStartYear = startYear;
      currentEndYear = endYear;
      buildGrid(currentStartYear, currentEndYear);

      if (!items.length) {
        renderEmpty("Esta entidad todavía no tiene cargos con fechas completas.");
        return;
      }

      if (type === "persona") {
        renderLane("Cargos", "Barras = periodos de cargos · meses visibles", items, "persona", startYear);
      } else {
        renderLane("Ocupación de cargos", "Barras = personas en el tiempo · apilado si se empalman", items, "institucion", startYear);
      }

      scrollNearYear(currentStartYear + 10, currentStartYear);
    }

    function scrollNearYear(year, startYear) {
      const idx = (year - startYear) * 12;
      const x = Math.max(0, idx * getMonthWidth() - 200);
      scroller.scrollLeft = x;
    }

    function scrollToToday() {
      const now = new Date();
      const idx = monthIndex(now, currentStartYear);
      const x = Math.max(0, idx * getMonthWidth() - 260);
      scroller.scrollLeft = x;
    }

    function populateEntities() {
      const type = entityType.value;
      entitySelect.innerHTML = "";

      const list = type === "persona" ? PERSONAS : INSTITUCIONES;
      const sorted = [...list].sort((a, b) => a.nombre.localeCompare(b.nombre));
      sorted.forEach((item) => {
        const opt = document.createElement("option");
        opt.value = item.id;
        opt.textContent = item.nombre;
        entitySelect.appendChild(opt);
      });

      if (!sorted.length) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Sin resultados";
        entitySelect.appendChild(opt);
      }
    }

    entityType.addEventListener("change", () => {
      populateEntities();
      renderTimeline();
    });

    entitySelect.addEventListener("change", renderTimeline);

    populateEntities();
    renderTimeline();
  </script>
</body>
</html>
