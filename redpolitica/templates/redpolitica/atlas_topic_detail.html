{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Atlas · Grafo de {{ topic.name }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/atlas-design-system.css' %}">
  <script src="https://unpkg.com/cytoscape@3.28.0/dist/cytoscape.min.js"></script>
</head>

<body>
  <div class="page">
    <header>
      <div class="header-inner">
        <div class="header-row">
          <a class="brand" href="{% url 'atlas-home' %}">
            <img src="{% static 'img/logo-horizonte-atlas.png' %}" alt="Atlas" class="brand-logo">
            <div class="brand-texts">
              <div class="brand-text-main">Atlas · Grafo por tema</div>
              <div class="brand-text-sub">{{ topic.name }}</div>
            </div>
          </a>
        </div>
        <div class="header-row header-row-nav">
          <nav class="chips-row" aria-label="Navegación de Atlas">
            <a class="chip-link" href="{% url 'atlas-home' %}">Home</a>
            <a class="chip-link" href="{% url 'atlas-topics-list' %}">Temas</a>
            <a class="chip-link" href="{% url 'atlas-personas-list' %}">Personas</a>
            <a class="chip-link" href="{% url 'atlas-instituciones-list' %}">Instituciones</a>
          </nav>
        </div>
      </div>
    </header>

    <main>
      <div class="layout">
        <section class="graph-area">
          <div class="graph-frame">
            <div class="graph-grid"></div>
            <div class="graph-label">
              Grafo temático de {{ topic.name }}
            </div>
            <div id="cy" style="width: 100%; height: 600px; min-height: 500px;"></div>
            <div class="graph-caption">
              Usa scroll / pinch para hacer zoom. Toca un nodo o relación para ver detalles en el panel lateral.
            </div>
          </div>
        </section>

        <aside id="side-panel">
          <div>
            <div id="panel-header">Red temática</div>
            <div id="panel-title">{{ topic.name }}</div>
            <div id="panel-content">
              <p><strong>Tipo:</strong> {{ topic.get_topic_kind_display }}</p>
              <p><strong>Estado:</strong> {{ topic.get_status_display }}</p>
              {% if topic.description %}
              <p>{{ topic.description }}</p>
              {% endif %}
            </div>
          </div>

          <div class="panel-section">
            <div class="panel-section-title">Filtros de vista</div>
            <div class="toggle-list">
              <label class="toggle-item">
                <input type="checkbox" id="toggle-people" checked />
                <span>Mostrar personas vinculadas</span>
              </label>
              <label class="toggle-item">
                <input type="checkbox" id="toggle-institutions" checked />
                <span>Mostrar instituciones vinculadas</span>
              </label>
              <label class="toggle-item">
                <input type="checkbox" id="toggle-hierarchy" checked />
                <span>Mostrar tema padre e hijos</span>
              </label>
            </div>
          </div>

          <div class="panel-section">
            <div class="panel-section-title">Leyenda</div>
            <div id="legend">
              <div class="legend-item">
                <span class="legend-color central"></span>
                <span>Tema central</span>
              </div>
              <div class="legend-item">
                <span class="legend-color topic"></span>
                <span>Temas relacionados</span>
              </div>
              <div class="legend-item">
                <span class="legend-color inst-padre"></span>
                <span>Instituciones</span>
              </div>
              <div class="legend-item">
                <span class="legend-color persona"></span>
                <span>Personas</span>
              </div>
              <div class="legend-item">
                <span class="legend-color line"></span>
                <span>Relaciones</span>
              </div>
            </div>
          </div>

          <div class="panel-section" id="related-people-section" style="display:none;">
            <div class="panel-section-title">Personas relacionadas</div>
            <div id="related-people"></div>
          </div>

          <div class="panel-section" id="related-institutions-section" style="display:none;">
            <div class="panel-section-title">Instituciones vinculadas</div>
            <div id="related-institutions"></div>
          </div>

          <div class="panel-section" id="related-topics-section" style="display:none;">
            <div class="panel-section-title">Temas relacionados</div>
            <div id="related-topics"></div>
          </div>
        </aside>
      </div>
    </main>

    <footer>
      Horizonte Digital · Atlas · <a href="{% url 'privacy-notice' %}">Aviso de privacidad</a> · <a
        href="{% url 'terms-conditions' %}">Términos y condiciones</a>
    </footer>
  </div>

  <script>
    const graphContainer = document.getElementById("cy");
    const hierarchyToggle = document.getElementById("toggle-hierarchy");
    const peopleToggle = document.getElementById("toggle-people");
    const institutionsToggle = document.getElementById("toggle-institutions");
    const panelTitle = document.getElementById("panel-title");
    const panelContent = document.getElementById("panel-content");
    const relatedPeopleSection = document.getElementById("related-people-section");
    const relatedPeopleContainer = document.getElementById("related-people");
    const relatedInstitutionsSection = document.getElementById("related-institutions-section");
    const relatedInstitutionsContainer = document.getElementById("related-institutions");
    const relatedTopicsSection = document.getElementById("related-topics-section");
    const relatedTopicsContainer = document.getElementById("related-topics");
    const slug = "{{ topic.slug }}";

    let topicsMap = {};
    let institutionsMap = {};
    let peopleMap = {};
    let cy = null;

    function buildGraphUrl() {
      const params = new URLSearchParams();
      if (hierarchyToggle && hierarchyToggle.checked) {
        params.set("hierarchy", "1");
      }
      const query = params.toString();
      return `/apps/atlas/temas/${slug}/grafo.json${query ? `?${query}` : ""}`;
    }

    function setPanelForTopic(topic) {
      panelTitle.textContent = topic.label || topic.nombre || "Tema";
      let html = "";

      if (topic.topic_kind_label || topic.topic_kind) {
        html += `<p><strong>Tipo:</strong> ${topic.topic_kind_label || topic.topic_kind}</p>`;
      }
      if (topic.status_label || topic.status) {
        html += `<p><strong>Estado:</strong> ${topic.status_label || topic.status}</p>`;
      }
      if (topic.description) {
        html += `<p>${topic.description}</p>`;
      }

      panelContent.innerHTML = html || "<p>Sin detalles adicionales.</p>";
    }

    function setPanelForInstitution(inst) {
      panelTitle.textContent = inst.label || inst.nombre || "Institución";
      let html = "";

      if (inst.tipo) {
        html += `<p><strong>Tipo:</strong> ${inst.tipo}</p>`;
      }
      if (inst.ambito) {
        html += `<p><strong>Ámbito:</strong> ${inst.ambito}</p>`;
      }

      const partes = [];
      if (inst.ciudad) partes.push(inst.ciudad);
      if (inst.estado) partes.push(inst.estado);
      if (inst.pais) partes.push(inst.pais);
      if (partes.length) {
        html += `<p><strong>Ubicación:</strong> ${partes.join(", ")}</p>`;
      }

      panelContent.innerHTML = html || "<p>Sin detalles adicionales.</p>";
    }

    function setPanelForPerson(person) {
      panelTitle.textContent = person.label || person.nombre_completo || "Persona";
      let html = "";

      if (person.bio_corta) {
        html += `<p>${person.bio_corta}</p>`;
      }

      panelContent.innerHTML = html || "<p>Sin detalles adicionales.</p>";
    }

    function setPanelForEdge(edge) {
      panelTitle.textContent = "Relación";
      panelContent.innerHTML = edge.label
        ? `<p><strong>Detalle:</strong> ${edge.label}</p>`
        : "<p>Relación entre nodos.</p>";
    }

    function renderChips(items, section, container, buildChip) {
      container.innerHTML = "";
      if (items.length) {
        section.style.display = "block";
        items.forEach(item => {
          const chip = buildChip(item);
          if (chip) {
            container.appendChild(chip);
          }
        });
      } else {
        section.style.display = "none";
      }
    }

    function renderGraph(data) {
      if (!graphContainer) return;
      const elements = [];

      topicsMap = {};
      institutionsMap = {};
      peopleMap = {};

      (data.nodes || []).forEach(node => {
        const tipo = node.type;
        elements.push({ data: { ...node, id: node.id, label: node.label, tipo } });

        if (tipo === "institution") {
          institutionsMap[node.id] = node;
        } else if (tipo === "person") {
          peopleMap[node.id] = node;
        } else if (tipo && tipo.startsWith("topic")) {
          topicsMap[node.id] = node;
        }
      });

      (data.edges || []).forEach((edge, idx) => {
        elements.push({
          data: {
            id: `e-${idx}`,
            source: edge.source,
            target: edge.target,
            label: edge.label || "",
            tipo: edge.type,
          }
        });
      });

      if (cy) {
        cy.destroy();
      }

      cy = cytoscape({
        container: graphContainer,
        elements,
        layout: {
          name: "concentric",
          animate: false,
          padding: 40,
          minNodeSpacing: 40,
          concentric: (node) => {
            const tipo = node.data("tipo");
            if (tipo === "topic") return 3;
            if (tipo && tipo.startsWith("topic")) return 2;
            if (tipo === "person" || tipo === "institution") return 1;
            return 0;
          },
          levelWidth: () => 1
        },
        style: [
          {
            selector: "node",
            style: {
              "background-color": "#4b5563",
              "label": "data(label)",
              "color": "#ffffff",
              "font-family": "Lexend, system-ui, sans-serif",
              "text-valign": "center",
              "text-halign": "center",
              "font-size": 11,
              "width": 48,
              "height": 48,
              "text-background-color": "#0b1220",
              "text-background-opacity": 1,
              "text-background-padding": 3,
              "text-background-shape": "round-rectangle"
            }
          },
          {
            selector: "node[tipo = 'topic']",
            style: {
              "background-color": "#f7931a",
              "border-width": 1,
              "border-color": "#f59e0b",
              "width": 64,
              "height": 64,
              "font-size": 13,
              "font-weight": "bold",
              "text-background-color": "#0b1220"
            }
          },
          {
            selector: "node[tipo = 'topic_parent']",
            style: {
              "shape": "round-rectangle",
              "background-color": "#1f2937",
              "border-width": 1,
              "border-color": "#f59e0b",
              "width": 150,
              "height": 40,
              "font-size": 11,
              "font-weight": "600",
              "text-wrap": "wrap",
              "text-max-width": 130,
              "text-background-color": "#0c1220",
              "text-background-opacity": 0.9
            }
          },
          {
            selector: "node[tipo = 'topic_child']",
            style: {
              "shape": "round-rectangle",
              "background-color": "#1f2937",
              "border-width": 1,
              "border-color": "#f59e0b",
              "width": 150,
              "height": 40,
              "font-size": 11,
              "font-weight": "600",
              "text-wrap": "wrap",
              "text-max-width": 130,
              "text-background-color": "#0c1220",
              "text-background-opacity": 0.9
            }
          },
          {
            selector: "node[tipo = 'institution']",
            style: {
              "shape": "round-rectangle",
              "background-color": "#1a1025",
              "border-width": 1,
              "border-color": "#4b3f5f",
              "width": 150,
              "height": 40,
              "font-size": 11,
              "text-wrap": "wrap",
              "text-max-width": 140
            }
          },
          {
            selector: "node[tipo = 'person']",
            style: {
              "background-color": "#e8a87c",
              "border-width": 1,
              "border-color": "#f59e0b",
              "width": 42,
              "height": 42,
              "font-size": 11,
              "text-background-color": "#0b1220"
            }
          },
          {
            selector: "edge",
            style: {
              "width": 2,
              "line-color": "#9aa0a6",
              "target-arrow-color": "#9aa0a6",
              "target-arrow-shape": "triangle",
              "curve-style": "bezier",
              "label": "data(label)",
              "font-size": 8,
              "text-rotation": "autorotate"
            }
          }
        ]
      });

      cy.on("tap", "node", event => {
        const node = event.target;
        const tipo = node.data("tipo");
        const dataNode = node.data();

        if (tipo === "institution") {
          setPanelForInstitution(dataNode);
        } else if (tipo === "person") {
          setPanelForPerson(dataNode);
        } else if (tipo && tipo.startsWith("topic")) {
          setPanelForTopic(dataNode);
        }
      });

      cy.on("tap", "edge", event => {
        setPanelForEdge(event.target.data());
      });

      const centralId = data.meta && data.meta.topic_id ? `topic:${data.meta.topic_id}` : null;
      const topicsList = Object.values(topicsMap).filter(topic => topic.id !== centralId);
      const peopleList = Object.values(peopleMap);
      const institutionsList = Object.values(institutionsMap);

      renderChips(peopleList, relatedPeopleSection, relatedPeopleContainer, person => {
        if (!person.slug) return null;
        const chip = document.createElement("a");
        chip.className = "chip-link";
        chip.href = `/api/personas/${person.slug}/grafo-page/`;
        chip.textContent = person.label || person.nombre_completo;
        return chip;
      });

      renderChips(institutionsList, relatedInstitutionsSection, relatedInstitutionsContainer, inst => {
        if (!inst.slug) return null;
        const chip = document.createElement("a");
        chip.className = "chip-link";
        chip.href = `/api/instituciones/${inst.slug}/grafo-page/`;
        chip.textContent = inst.label || inst.nombre;
        return chip;
      });

      renderChips(topicsList, relatedTopicsSection, relatedTopicsContainer, topic => {
        if (!topic.slug) return null;
        const chip = document.createElement("a");
        chip.className = "chip-link";
        chip.href = `/apps/atlas/temas/${topic.slug}/`;
        chip.textContent = topic.label || topic.nombre;
        return chip;
      });

      applyVisibilityFilters();
    }

    function applyVisibilityFilters() {
      if (!cy) return;
      const showPeople = peopleToggle ? peopleToggle.checked : true;
      const showInstitutions = institutionsToggle ? institutionsToggle.checked : true;

      cy.batch(() => {
        cy.nodes("[tipo = 'person']").style("display", showPeople ? "element" : "none");
        cy.nodes("[tipo = 'institution']").style(
          "display",
          showInstitutions ? "element" : "none"
        );

        cy.edges("[tipo = 'person_topic_manual'], [tipo = 'person_topic_inherited']").style(
          "display",
          showPeople ? "element" : "none"
        );
        cy.edges("[tipo = 'institution_topic']").style(
          "display",
          showInstitutions ? "element" : "none"
        );

        cy.edges().forEach(edge => {
          const sourceVisible = edge.source().style("display") !== "none";
          const targetVisible = edge.target().style("display") !== "none";
          if (!sourceVisible || !targetVisible) {
            edge.style("display", "none");
          }
        });
      });

      name: "concentric",
        animate: false,
          padding: 40
    }).run();

    cy.resize();
    cy.fit();
    }

    function loadGraph() {
      fetch(buildGraphUrl())
        .then(res => res.json())
        .then(renderGraph)
        .catch(err => {
          console.error("Error cargando grafo del tema:", err);
        });
    }

    if (hierarchyToggle) {
      hierarchyToggle.addEventListener("change", loadGraph);
    }
    if (peopleToggle) {
      peopleToggle.addEventListener("change", applyVisibilityFilters);
    }
    if (institutionsToggle) {
      institutionsToggle.addEventListener("change", applyVisibilityFilters);
    }

    loadGraph();
  </script>
</body>

</html>