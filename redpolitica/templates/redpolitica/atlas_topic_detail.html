{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Atlas · {{ topic.name }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/atlas-design-system.css' %}">
  <script src="https://unpkg.com/cytoscape@3.28.0/dist/cytoscape.min.js"></script>
</head>
<body>
  <div class="page">
    <header>
      <div class="header-inner">
        <div class="header-row">
          <a class="brand" href="{% url 'atlas-home' %}">
            <img src="{% static 'img/logo-horizonte-atlas.png' %}" alt="Atlas" class="brand-logo">
            <div class="brand-texts">
              <div class="brand-text-main">Atlas · Tema</div>
              <div class="brand-text-sub">{{ topic.name }}</div>
            </div>
          </a>
        </div>
        <div class="header-row header-row-nav">
          <nav class="chips-row" aria-label="Navegación de Atlas">
            <a class="chip-link" href="{% url 'atlas-home' %}">Home</a>
            <a class="chip-link" href="{% url 'atlas-topics-list' %}">Temas</a>
            <a class="chip-link" href="{% url 'atlas-personas-list' %}">Personas</a>
            <a class="chip-link" href="{% url 'atlas-instituciones-list' %}">Instituciones</a>
          </nav>
        </div>
      </div>
    </header>

    <main>
      <div class="main-inner">
        <section class="panel">
          <div class="panel-title">{{ topic.name }}</div>
          <div class="panel-desc">{{ topic.get_topic_kind_display }} · {{ topic.get_status_display }}</div>
          {% if topic.description %}
            <p>{{ topic.description }}</p>
          {% endif %}
          {% if breadcrumb %}
            <div class="chips-row" style="margin-top: 8px;">
              {% for parent in breadcrumb %}
                <a class="chip-link" href="{% url 'atlas-topic-detail' slug=parent.slug %}">{{ parent.name }}</a>
              {% endfor %}
              <span class="chip-link" aria-current="page">{{ topic.name }}</span>
            </div>
          {% endif %}
          {% if children %}
            <div style="margin-top: 12px;">
              <strong>Temas hijos:</strong>
              <div class="chips-row" style="margin-top: 6px;">
                {% for child in children %}
                  <a class="chip-link" href="{% url 'atlas-topic-detail' slug=child.slug %}">{{ child.name }}</a>
                {% endfor %}
              </div>
            </div>
          {% endif %}
          <div class="hero-actions" style="margin-top: 12px;">
            <a class="btn btn-primary" href="{% url 'atlas-topic-edit' slug=topic.slug %}">Editar tema</a>
          </div>
        </section>

        {% if messages %}
          <section class="panel">
            {% for message in messages %}
              <div class="card-desc">{{ message }}</div>
            {% endfor %}
          </section>
        {% endif %}

        <section class="panel">
          <div class="panel-title">Grafo del tema</div>
          <div class="panel-desc">Visualiza instituciones, personas y jerarquía del tema.</div>
          <div class="toggle-list">
            <label class="toggle-item">
              <input type="checkbox" id="toggle-hierarchy" checked />
              <span>Mostrar tema padre e hijos</span>
            </label>
          </div>
          <div class="graph-frame" style="margin-top: 12px;">
            <div class="graph-grid"></div>
            <div id="topic-graph" style="min-height: 420px;"></div>
          </div>
        </section>

        <section class="panel">
          <div class="panel-title">Instituciones vinculadas</div>
          <div class="panel-desc">Relaciones directas con el tema.</div>
          <table class="table" style="width:100%; margin-top: 8px;">
            <thead>
              <tr>
                <th>Institución</th>
                <th>Rol</th>
                <th>Nota</th>
                <th>Vigencia</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for link in institution_links %}
                <tr>
                  <td>{{ link.institution.nombre }}</td>
                  <td>{{ link.role }}</td>
                  <td>{{ link.note|default:"—" }}</td>
                  <td>
                    {% if link.valid_from or link.valid_to %}
                      {{ link.valid_from|default:"¿?" }} – {{ link.valid_to|default:"actual" }}
                    {% else %}
                      —
                    {% endif %}
                  </td>
                  <td>
                    <form method="post" action="{% url 'atlas-topic-unlink-institution' slug=topic.slug link_id=link.id %}">
                      {% csrf_token %}
                      <button class="btn" type="submit">Eliminar</button>
                    </form>
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="5">Sin instituciones vinculadas.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>

          <form method="post" action="{% url 'atlas-topic-link-institution' slug=topic.slug %}" class="form-grid" style="margin-top: 16px;">
            {% csrf_token %}
            <div class="form-row">
              <label>Institución</label>
              {{ institution_form.institution }}
            </div>
            <div class="form-row">
              <label>Rol</label>
              {{ institution_form.role }}
            </div>
            <div class="form-row">
              <label>Nota</label>
              {{ institution_form.note }}
            </div>
            <div class="form-row">
              <label>Vigencia inicio</label>
              {{ institution_form.valid_from }}
            </div>
            <div class="form-row">
              <label>Vigencia fin</label>
              {{ institution_form.valid_to }}
            </div>
            <div class="form-actions">
              <button class="btn btn-primary" type="submit">Vincular institución</button>
            </div>
          </form>
        </section>

        <section class="panel">
          <div class="panel-title">Personas vinculadas (manual)</div>
          <table class="table" style="width:100%; margin-top: 8px;">
            <thead>
              <tr>
                <th>Persona</th>
                <th>Rol</th>
                <th>Nota</th>
                <th>Fuente</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for link in person_links %}
                <tr>
                  <td>{{ link.person.nombre_completo }}</td>
                  <td>{{ link.role }}</td>
                  <td>{{ link.note|default:"—" }}</td>
                  <td>
                    {% if link.source_url %}
                      <a href="{{ link.source_url }}" target="_blank" rel="noopener">Fuente</a>
                    {% else %}
                      —
                    {% endif %}
                  </td>
                  <td>
                    <form method="post" action="{% url 'atlas-topic-unlink-person' slug=topic.slug link_id=link.id %}">
                      {% csrf_token %}
                      <button class="btn" type="submit">Eliminar</button>
                    </form>
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="5">Sin personas vinculadas manualmente.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>

          <form method="post" action="{% url 'atlas-topic-link-person' slug=topic.slug %}" class="form-grid" style="margin-top: 16px;">
            {% csrf_token %}
            <div class="form-row">
              <label>Persona</label>
              {{ person_form.person }}
            </div>
            <div class="form-row">
              <label>Rol</label>
              {{ person_form.role }}
            </div>
            <div class="form-row">
              <label>Nota</label>
              {{ person_form.note }}
            </div>
            <div class="form-row">
              <label>Fuente</label>
              {{ person_form.source_url }}
            </div>
            <div class="form-actions">
              <button class="btn btn-primary" type="submit">Vincular persona</button>
            </div>
          </form>
        </section>

        <section class="panel">
          <div class="panel-title">Personas heredadas por cargos</div>
          <div class="panel-desc">Personas que ocupan cargos en instituciones vinculadas al tema.</div>
          <table class="table" style="width:100%; margin-top: 8px;">
            <thead>
              <tr>
                <th>Persona</th>
                <th>Institución</th>
                <th>Cargo</th>
                <th>Periodo</th>
              </tr>
            </thead>
            <tbody>
              {% for cargo in inherited_cargos %}
                <tr>
                  <td>{{ cargo.persona.nombre_completo }}</td>
                  <td>{{ cargo.institucion.nombre }}</td>
                  <td>{{ cargo.nombre_cargo }}</td>
                  <td>
                    {% if cargo.fecha_inicio or cargo.fecha_fin %}
                      {{ cargo.fecha_inicio|default:"¿?" }} – {{ cargo.fecha_fin|default:"actual" }}
                    {% else %}
                      —
                    {% endif %}
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="4">Sin cargos heredados para este tema.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </section>
      </div>
    </main>

    <footer>
      Horizonte Digital · Atlas · <a href="{% url 'privacy-notice' %}">Aviso de privacidad</a> · <a href="{% url 'terms-conditions' %}">Términos y condiciones</a>
    </footer>
  </div>

  <script>
    const graphContainer = document.getElementById("topic-graph");
    const hierarchyToggle = document.getElementById("toggle-hierarchy");
    const slug = "{{ topic.slug }}";

    function buildGraphUrl() {
      const params = new URLSearchParams();
      if (hierarchyToggle && hierarchyToggle.checked) {
        params.set("hierarchy", "1");
      }
      const query = params.toString();
      return `/apps/atlas/temas/${slug}/grafo.json${query ? `?${query}` : ""}`;
    }

    function renderGraph(data) {
      if (!graphContainer) return;
      const elements = [];

      (data.nodes || []).forEach(node => {
        elements.push({ data: { id: node.id, label: node.label, tipo: node.type } });
      });

      (data.edges || []).forEach((edge, idx) => {
        elements.push({
          data: {
            id: `e-${idx}`,
            source: edge.source,
            target: edge.target,
            label: edge.label || "",
            tipo: edge.type
          }
        });
      });

      cytoscape({
        container: graphContainer,
        elements,
        layout: {
          name: "concentric",
          animate: false,
          padding: 40
        },
        style: [
          {
            selector: "node",
            style: {
              "background-color": "#4b5563",
              "label": "data(label)",
              "color": "#ffffff",
              "font-family": "Lexend, system-ui, sans-serif",
              "text-valign": "center",
              "text-halign": "center",
              "font-size": 11,
              "width": 48,
              "height": 48,
              "text-background-color": "rgba(0,0,0,0.7)",
              "text-background-opacity": 1,
              "text-background-padding": 3,
              "text-background-shape": "round-rectangle"
            }
          },
          {
            selector: "node[tipo = 'topic']",
            style: {
              "background-color": "#f7931a",
              "width": 70,
              "height": 70,
              "font-size": 13,
              "font-weight": "bold"
            }
          },
          {
            selector: "node[tipo = 'topic_parent']",
            style: {
              "background-color": "#ffb347",
              "width": 56,
              "height": 56
            }
          },
          {
            selector: "node[tipo = 'topic_child']",
            style: {
              "background-color": "#fcd34d",
              "width": 52,
              "height": 52
            }
          },
          {
            selector: "node[tipo = 'institution']",
            style: {
              "shape": "round-rectangle",
              "background-color": "#1a1025",
              "border-width": 1,
              "border-color": "#4b3f5f",
              "width": 160,
              "height": 44,
              "font-size": 11,
              "text-wrap": "wrap",
              "text-max-width": 140
            }
          },
          {
            selector: "node[tipo = 'person']",
            style: {
              "background-color": "#e8a87c",
              "width": 44,
              "height": 44
            }
          },
          {
            selector: "edge",
            style: {
              "width": 2,
              "line-color": "#9aa0a6",
              "target-arrow-color": "#9aa0a6",
              "target-arrow-shape": "triangle",
              "curve-style": "bezier",
              "label": "data(label)",
              "font-size": 8,
              "text-rotation": "autorotate"
            }
          }
        ]
      });
    }

    function loadGraph() {
      fetch(buildGraphUrl())
        .then(res => res.json())
        .then(renderGraph)
        .catch(err => {
          console.error("Error cargando grafo del tema:", err);
        });
    }

    if (hierarchyToggle) {
      hierarchyToggle.addEventListener("change", loadGraph);
    }

    loadGraph();
  </script>
</body>
</html>
