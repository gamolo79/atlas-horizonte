{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Atlas · Grafo de {{ persona.nombre_completo }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Lexend -->
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/atlas-design-system.css' %}">
  <script src="{% static 'js/offcanvas-menu.js' %}" defer></script>

  <!-- Cytoscape -->
  <script src="https://unpkg.com/cytoscape@3.28.0/dist/cytoscape.min.js"></script>
</head>
<body>
<div class="page">
  <header>
    <div class="header-inner">
      <div class="brand">
        <img src="{% static 'img/logo-horizonte-atlas.png' %}" alt="Horizonte Digital Atlas" class="brand-logo">
        <div class="brand-labels">
          <div class="brand-text-main">Atlas · Grafo por persona</div>
          <div class="brand-text-sub">Personas e instituciones conectadas</div>
        </div>
      </div>

      <nav class="app-nav" aria-label="Navegación principal">
        <a class="app-nav-link" href="{% url 'atlas-home' %}">Inicio</a>
        <a class="app-nav-link" href="{% url 'atlas-personas-list' %}">Personas</a>
        <a class="app-nav-link" href="{% url 'atlas-instituciones-list' %}">Instituciones</a>
      </nav>
      <div class="header-actions">
        <span class="tag-app">
          <span class="tag-dot"></span> Vista de grafo
        </span>
        <a class="app-nav-link app-switch" href="{% url 'index-apps' %}">Ecosistema</a>
        <div class="mobile-nav">
          <button class="menu-button" type="button" aria-label="Abrir menú" aria-expanded="false" aria-controls="atlas-offcanvas">
            <span></span>
          </button>
          <div class="offcanvas" id="atlas-offcanvas">
            <div class="offcanvas-header">
              <div class="offcanvas-title">
                <div class="offcanvas-product">Atlas</div>
                <div class="offcanvas-subtitle">Personas · Instituciones · Relaciones</div>
              </div>
              <button class="offcanvas-close" type="button" aria-label="Cerrar menú">×</button>
            </div>
            <nav class="offcanvas-section">
              <div class="offcanvas-section-title">Explorar Atlas</div>
              <a class="offcanvas-link" href="{% url 'atlas-home' %}">Inicio</a>
              <a class="offcanvas-link" href="{% url 'atlas-personas-list' %}">Personas</a>
              <a class="offcanvas-link" href="{% url 'atlas-instituciones-list' %}">Instituciones</a>
            </nav>
            <div class="offcanvas-divider"></div>
            <nav class="offcanvas-section">
              <div class="offcanvas-section-title">Ecosistema</div>
              <a class="offcanvas-link" href="{% url 'index-apps' %}">Volver al ecosistema</a>
            </nav>
            <div class="offcanvas-footer">
              <a href="{% url 'privacy-notice' %}">Aviso de privacidad</a>
              <a href="{% url 'terms-conditions' %}">Términos y condiciones</a>
            </div>
          </div>
          <button class="offcanvas-backdrop" type="button" aria-hidden="true"></button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="layout">
      <!-- Área de grafo -->
      <section class="graph-area">
        <div class="graph-frame">
          <div class="graph-grid"></div>
          <div class="graph-label">
            Grafo político de {{ persona.nombre_completo }}
          </div>
          <div id="cy"></div>
          <div class="graph-caption">
            Usa scroll / pinch para hacer zoom. Toca un nodo o flecha para ver detalles en el panel lateral.
          </div>
        </div>
      </section>

      <!-- Panel lateral -->
      <aside id="side-panel">
        <div>
          <div id="panel-header">Red política</div>
          <div id="panel-title">{{ persona.nombre_completo }}</div>
        </div>

        <div id="panel-content">
          <p>Selecciona una persona, institución o relación para ver detalles.</p>
        </div>

        <!-- Filtros -->
        <div class="panel-section">
          <div class="panel-section-title">Filtros de vista</div>
          <div class="filters">
            <label class="filter-item">
              <input type="checkbox" id="toggle-cargos" checked>
              <span>Mostrar cargos (persona → institución)</span>
            </label>
            <label class="filter-item">
              <input type="checkbox" id="toggle-relaciones" checked>
              <span>Mostrar relaciones entre personas</span>
            </label>
          </div>
          <div class="panel-subtitle" style="margin-top: 8px;">Vista</div>
          <div class="toggle-list">
            <label class="toggle-item">
              <input type="radio" name="vista" value="instituciones">
              <span>Instituciones</span>
            </label>
            <label class="toggle-item">
              <input type="radio" name="vista" value="familiar">
              <span>Red familiar</span>
            </label>
            <label class="toggle-item">
              <input type="radio" name="vista" value="politica">
              <span>Red política / afinidad</span>
            </label>
            <label class="toggle-item">
              <input type="radio" name="vista" value="laboral">
              <span>Red laboral</span>
            </label>
            <label class="toggle-item">
              <input type="radio" name="vista" value="completa" checked>
              <span>Vista completa</span>
            </label>
          </div>

          <div class="panel-subtitle" style="margin-top: 8px;">Grado de conexión</div>
          <div class="toggle-list">
            <label class="toggle-item">
              <input type="radio" name="grado" value="1" checked>
              <span>Grado 1</span>
            </label>
            <label class="toggle-item">
              <input type="radio" name="grado" value="2">
              <span>Grado 2</span>
            </label>
            <label class="toggle-item">
              <input type="radio" name="grado" value="3">
              <span>Grado 3</span>
            </label>
          </div>
        </div>

        <!-- Leyenda -->
        <div class="panel-section">
          <div class="panel-section-title">Leyenda</div>
          <div id="legend">
            <div class="legend-item">
              <span class="legend-color central"></span>
              <span>Persona central</span>
            </div>
            <div class="legend-item">
              <span class="legend-color persona"></span>
              <span>Otras personas</span>
            </div>
            <div class="legend-item">
              <span class="legend-color inst-padre"></span>
              <span>Instituciones</span>
            </div>
            <div class="legend-item">
              <span class="legend-color line"></span>
              <span>Relaciones / cargos</span>
            </div>
          </div>
        </div>

        <!-- Navegación a otras personas -->
        <div class="panel-section" id="related-people-section" style="display:none;">
          <div class="panel-section-title">Otras personas relacionadas</div>
          <div id="related-people"></div>
        </div>

        <!-- Instituciones relacionadas con la persona central -->
        <div class="panel-section" id="related-institutions-section" style="display:none;">
          <div class="panel-section-title">Instituciones vinculadas</div>
          <div id="related-institutions"></div>
        </div>
      </aside>
    </div>
  </main>

  <footer>
    Horizonte Digital · Atlas · <a href="{% url 'privacy-notice' %}">Aviso de privacidad</a> · <a href="{% url 'terms-conditions' %}">Términos y condiciones</a>
  </footer>

  <div id="debug"></div>
</div>

<script>
  const slug = "{{ persona.slug }}";
  const API_URL = `/api/personas/${slug}/grafo/`;

  const debugEl = document.getElementById("debug");
  const panelTitle = document.getElementById("panel-title");
  const panelContent = document.getElementById("panel-content");

  const toggleCargosEl = document.getElementById("toggle-cargos");
  const toggleRelacionesEl = document.getElementById("toggle-relaciones");
  const vistaRadios = document.querySelectorAll("input[name='vista']");
  const gradoRadios = document.querySelectorAll("input[name='grado']");

  const relatedPeopleSection = document.getElementById("related-people-section");
  const relatedPeopleContainer = document.getElementById("related-people");

  const relatedInstitutionsSection = document.getElementById("related-institutions-section");
  const relatedInstitutionsContainer = document.getElementById("related-institutions");

  function mostrarErrorCarga(mensaje) {
    console.error(mensaje);
    panelTitle.textContent = "Error";
    panelContent.innerHTML = `<p>${mensaje}</p>`;
  }

  function renderRelatedChips(personasRelacionadas, institucionesRelacionadas) {
    relatedPeopleContainer.innerHTML = "";
    relatedInstitutionsContainer.innerHTML = "";

    if (personasRelacionadas.length) {
      relatedPeopleSection.style.display = "block";
      personasRelacionadas.forEach(p => {
        const chip = document.createElement("button");
        chip.type = "button";
        chip.className = "person-chip";
        chip.textContent = p.nombre_completo;
        if (p.slug) {
          chip.addEventListener("click", () => {
            window.location.href = `/api/personas/${p.slug}/grafo-page/`;
          });
        }
        relatedPeopleContainer.appendChild(chip);
      });
    } else {
      relatedPeopleSection.style.display = "none";
    }

    if (institucionesRelacionadas.length) {
      relatedInstitutionsSection.style.display = "block";
      institucionesRelacionadas.forEach(inst => {
        const chip = document.createElement("a");
        chip.className = "chip-link";
        const slug = inst.slug || inst.id;
        chip.href = `/api/instituciones/${slug}/grafo-page/`;
        chip.textContent = inst.nombre;
        relatedInstitutionsContainer.appendChild(chip);
      });
    } else {
      relatedInstitutionsSection.style.display = "none";
    }
  }

  let personasMap = {};
  let institucionesMap = {};
  let cy = null;

  function logDebug(msg, obj) {
    if (!debugEl) return;
    const time = new Date().toISOString();
    debugEl.innerText += `\n[${time}] ${msg}`;
    if (obj) {
      debugEl.innerText += `\n` + JSON.stringify(obj, null, 2) + "\n";
    }
  }

  function setPanelForPersona(p) {
    panelTitle.textContent = p.nombre_completo;
    let html = "";

    if (p.bio_corta) {
      html += `<p>${p.bio_corta}</p>`;
    }

    if (p.cargos && p.cargos.length) {
      html += `<p><strong>Cargos registrados:</strong></p><ul>`;
      p.cargos.forEach(c => {
        const inst = c.institucion;
        const instNombre = inst ? inst.nombre : "(Institución no registrada)";
        html += `<li>${c.nombre_cargo} – ${instNombre}</li>`;
      });
      html += `</ul>`;
    } else {
      html += `<p>Sin cargos registrados en la base.</p>`;
    }

    panelContent.innerHTML = html;
  }

  function setPanelForInstitucion(inst) {
    panelTitle.textContent = inst.nombre;
    let html = "";

    html += `<p><strong>Tipo:</strong> ${inst.tipo || "—"}</p>`;
    if (inst.ambito) {
      html += `<p><strong>Ámbito:</strong> ${inst.ambito}</p>`;
    }

    const partes = [];
    if (inst.ciudad) partes.push(inst.ciudad);
    if (inst.estado) partes.push(inst.estado);
    if (inst.pais) partes.push(inst.pais);
    if (partes.length) {
      html += `<p><strong>Ubicación:</strong> ${partes.join(", ")}</p>`;
    }

    panelContent.innerHTML = html || "<p>Sin detalles adicionales.</p>";
  }

  function setPanelForRelacion(rel, personasMap, institucionesMap) {
    const tipoPretty = {
      familiar: "Relación familiar",
      amistad: "Amistad / cercanía personal",
      socio: "Socios / negocios",
      grupo_politico: "Mismo grupo político",
      laboral: "Relación laboral",
      cargo: "Cargo en institución",
      otro: "Otro tipo de relación",
    }[rel.tipo] || rel.tipo;

    panelTitle.textContent = tipoPretty;
    let html = "<p>";

    if (rel.tipo === "cargo") {
      const persona = personasMap[rel.persona_id];
      const inst = institucionesMap[rel.institucion_padre_id] || institucionesMap[rel.institucion_id];

      if (persona) {
        html += `<strong>${persona.nombre_completo}</strong><br/>`;
      }

      if (inst) {
        html += `${rel.cargo_nombre || "Cargo"} en <strong>${inst.nombre}</strong></p>`;
      } else {
        html += "Relación persona ↔ institución</p>";
      }

      if (rel.fecha_inicio || rel.fecha_fin) {
        html += `<p><strong>Periodo:</strong> ${
          rel.fecha_inicio || "¿?"
        } – ${rel.fecha_fin || "actual o sin registro"}</p>`;
      }

      if (rel.notas) {
        html += `<p><strong>Notas:</strong> ${rel.notas}</p>`;
      }
    } else {
      const origen = personasMap[rel.origen];
      const destino = personasMap[rel.destino];

      if (origen && destino) {
        html += `<strong>${origen.nombre_completo}</strong> ↔ <strong>${destino.nombre_completo}</strong></p>`;
      }

      if (rel.descripcion) {
        html += `<p><strong>Descripción:</strong> ${rel.descripcion}</p>`;
      }

      if (rel.fuente) {
        html += `<p><strong>Fuente:</strong> ${rel.fuente}</p>`;
      }
    }

    panelContent.innerHTML = html || "<p>Sin detalles adicionales.</p>";
  }

  function getTopParent(inst) {
    if (!inst) return null;
    let current = inst;
    let safety = 20;
    while (current.padre && institucionesMap[current.padre] && safety > 0) {
      current = institucionesMap[current.padre];
      safety--;
    }
    return current;
  }

  function getVistaActual() {
    const checked = Array.from(vistaRadios).find(r => r.checked);
    return checked ? checked.value : "completa";
  }

  function getGradoMaximo() {
    const checked = Array.from(gradoRadios).find(r => r.checked);
    return checked ? parseInt(checked.value, 10) : 3;
  }

  function aplicarVista(vista) {
    if (!cy) return;

    const gradoMax = getGradoMaximo();
    const showCargos = toggleCargosEl.checked;
    const showRelaciones = toggleRelacionesEl.checked;

    const tiposPorVista = {
      instituciones: ["cargo"],
      familiar: ["familiar"],
      politica: ["grupo_politico", "socio", "amistad"],
      laboral: ["laboral"],
      completa: [
        "cargo",
        "familiar",
        "amistad",
        "socio",
        "grupo_politico",
        "laboral",
        "otro"
      ]
    };

    const allowedTipos = tiposPorVista[vista] || tiposPorVista.completa;

    cy.nodes().forEach(node => {
      const grado = node.data("grado");
      const visible = grado == null ? true : grado <= gradoMax;
      node.style("display", visible ? "element" : "none");
    });

    const allEdges = cy.edges();

    allEdges.forEach(edge => {
      const tipo = edge.data("tipo");
      const matchesVista = allowedTipos.includes(tipo);
      const matchesToggle = tipo === "cargo" ? showCargos : showRelaciones;

      const source = edge.source();
      const target = edge.target();
      const maxGrado = Math.max(
        source.data("grado") ?? Infinity,
        target.data("grado") ?? Infinity
      );
      const withinGrado = maxGrado <= gradoMax;
      const nodesVisible =
        source.style("display") !== "none" && target.style("display") !== "none";

      const showEdge = matchesVista && matchesToggle && withinGrado && nodesVisible;
      edge.style("display", showEdge ? "element" : "none");
    });

    cy.nodes().forEach(node => {
      const grado = node.data("grado");
      const withinGrado = grado == null ? true : grado <= gradoMax;
      const isCentral = node.data("tipo") === "persona_central";

      const hasVisibleEdges = node.connectedEdges().some(e => e.style("display") !== "none");
      const shouldShow = withinGrado && (isCentral || hasVisibleEdges);

      node.style("display", shouldShow ? "element" : "none");
    });

    cy.nodes().forEach(node => {
      const grado = node.data("grado");
      const withinGrado = grado == null ? true : grado <= gradoMax;
      const isCentral = node.data("tipo") === "persona_central";

      const hasVisibleEdges = node.connectedEdges().some(e => e.style("display") !== "none");
      const shouldShow = withinGrado && (isCentral || hasVisibleEdges);

      node.style("display", shouldShow ? "element" : "none");
    });
  }

  function applyFilters() {
    aplicarVista(getVistaActual());
  }

  function applyFilters() {
    aplicarVista(getVistaActual());
  }

  function applyFilters() {
    aplicarVista(getVistaActual());
  }

  logDebug("Cargando grafo desde " + API_URL);

  fetch(API_URL)
    .then(res => {
      logDebug("Respuesta HTTP: " + res.status);
      if (!res.ok) {
        throw new Error(`Respuesta HTTP no exitosa: ${res.status}`);
      }
      return res.json();
    })
    .then(data => {
      logDebug("Datos recibidos:", data);

      if (!data || !data.persona_central) {
        throw new Error("Datos del grafo no disponibles o incompletos.");
      }

      const elements = [];
      personasMap = {};
      institucionesMap = {};

      // 1) Mapa de instituciones (todas, para resolver padres)
      (data.instituciones || []).forEach(inst => {
        institucionesMap[inst.id] = inst;
      });

      // 2) Persona central
      const central = data.persona_central;
      personasMap[central.id] = central;
      elements.push({
        data: {
          id: `p-${central.id}`,
          persona_id: central.id,
          label: central.nombre_completo,
          tipo: "persona_central"
        }
      });

      // 3) Instituciones TOP-LEVEL solo de la persona central
      const instPadreCentral = new Set();

      (central.cargos || []).forEach(cargo => {
        if (!cargo.institucion || cargo.institucion.id == null) return;

        const instOriginalId = cargo.institucion.id;
        const instOriginal = institucionesMap[instOriginalId] || cargo.institucion;
        const top = getTopParent(instOriginal) || instOriginal;

        if (top && top.id != null) {
          instPadreCentral.add(top.id);
        }
      });

      instPadreCentral.forEach(id => {
        const inst = institucionesMap[id];
        if (!inst) return;
        elements.push({
          data: {
            id: `i-${inst.id}`,
            institucion_id: inst.id,
            label: inst.nombre,
            tipo: "institucion",
            principal: "true"
          }
        });
      });

      // 4) Personas conectadas (nodos)
      (data.personas_conectadas || []).forEach(pc => {
        personasMap[pc.id] = pc;
        elements.push({
          data: {
            id: `p-${pc.id}`,
            persona_id: pc.id,
            slug: pc.slug || null,
            label: pc.nombre_completo,
            tipo: "persona"
          }
        });
      });

      // 5) Relaciones persona ↔ persona (aristas)
      (data.relaciones || []).forEach(rel => {
        elements.push({
          data: {
            id: `r-${rel.id}`,
            source: `p-${rel.origen}`,
            target: `p-${rel.destino}`,
            relacion_id: rel.id,
            tipo: rel.tipo || "otro",
            descripcion: rel.descripcion,
            fuente: rel.fuente
          }
        });
      });

      // 6) Cargos SOLO de la persona central: persona ↔ institución PADRE
      (central.cargos || []).forEach(cargo => {
        if (!cargo.institucion || cargo.institucion.id == null) return;

        const instOriginalId = cargo.institucion.id;
        const instOriginal = institucionesMap[instOriginalId] || cargo.institucion;
        const top = getTopParent(instOriginal) || instOriginal;
        if (!top || top.id == null) return;

        const targetNodeId = `i-${top.id}`;
        const edgeId = `c-${central.id}-${cargo.id}-${top.id}`;

        elements.push({
          data: {
            id: edgeId,
            source: `p-${central.id}`,
            target: targetNodeId,
            relacion_id: `cargo-${cargo.id}`,
            tipo: "cargo",
            cargo_nombre: cargo.nombre_cargo,
            persona_id: central.id,
            institucion_id: instOriginalId,
            institucion_padre_id: top.id,
            fecha_inicio: cargo.fecha_inicio || null,
            fecha_fin: cargo.fecha_fin || null,
            notas: cargo.notas || ""
          }
        });
      });

      logDebug("Elementos generados para Cytoscape:", elements);

      cy = cytoscape({
        container: document.getElementById("cy"),
        elements,
        layout: {
          name: "concentric",
          animate: false,
          padding: 35,
          minNodeSpacing: 40,   // un poco más compacto
          concentric: function(node) {
            const tipo = node.data("tipo");
            if (tipo === "persona_central") return 3;
            if (tipo === "persona") return 2;
            if (tipo === "institucion") return 1;
            return 0;
          },
          levelWidth: function() { return 1; }
        },
        style: [
          /* Base nodos */
          {
            selector: "node",
            style: {
              "background-color": "#4b5563",
              "label": "data(label)",
              "color": "#ffffff",
              "font-family": "Lexend, system-ui, sans-serif",
              "text-valign": "center",
              "text-halign": "center",
              "font-size": 11,
              "width": 38,
              "height": 38,
              "overlay-opacity": 0,
              "text-background-opacity": 1,
              "text-background-padding": 3,
              "text-background-shape": "round-rectangle",
              "text-outline-width": 0
            }
          },
          /* Persona central */
          {
            selector: "node[tipo = 'persona_central']",
            style: {
              "background-color": "#f7931a",
              "width": 56,
              "height": 56,
              "font-size": 13,
              "font-weight": "bold",
              "text-background-color": "#0b1220"
            }
          },
          /* Otras personas */
          {
            selector: "node[tipo = 'persona']",
            style: {
              "background-color": "#e8a87c",
              "width": 42,
              "height": 42,
              "font-size": 11,
              "text-background-color": "#0b1220"
            }
          },
          /* Instituciones */
          {
            selector: "node[tipo = 'institucion']",
            style: {
              "shape": "round-rectangle",
              "background-color": "#1a1025",
              "border-width": 1,
              "border-color": "#4b3f5f",
              "width": 150,
              "height": 40,
              "font-size": 11,
              "font-weight": "500",
              "text-wrap": "wrap",
              "text-max-width": 130,
              "text-background-color": "#0c1220",
              "text-background-opacity": 0.9
            }
          },
          /* Instituciones principales (padre) */
          {
            selector: "node[tipo = 'institucion'][principal]",
            style: {
              "background-color": "#2b1c3f",
              "border-color": "#c144d2",
              "color": "#ffffff"
            }
          },
          /* Aristas base */
          {
            selector: "edge",
            style: {
              "width": 2,
              "line-color": "#9aa0a6",
              "target-arrow-color": "#9aa0a6",
              "target-arrow-shape": "triangle",
              "curve-style": "bezier",
              "label": "",
              "font-size": 8,
              "text-rotation": "autorotate"
            }
          },
          /* Cargos un poquito más gruesos */
          {
            selector: "edge[tipo = 'cargo']",
            style: {
              "width": 2.5
            }
          },
          {
            selector: "edge[tipo = 'familiar']",
            style: {
              "line-color": "#f7931a",
              "target-arrow-color": "#f7931a"
            }
          },
          {
            selector: "edge[tipo = 'amistad']",
            style: {
              "line-color": "#a855f7",
              "target-arrow-color": "#a855f7"
            }
          },
          {
            selector: "edge[tipo = 'socio']",
            style: {
              "line-color": "#6366f1",
              "target-arrow-color": "#6366f1"
            }
          },
          {
            selector: "edge[tipo = 'grupo_politico']",
            style: {
              "line-color": "#22c55e",
              "target-arrow-color": "#22c55e"
            }
          },
          {
            selector: "edge[tipo = 'laboral']",
            style: {
              "line-color": "#ec4899",
              "target-arrow-color": "#ec4899"
            }
          },
          {
            selector: "edge[tipo = 'cargo']",
            style: {
              "line-color": "#cbd5e1",
              "target-arrow-color": "#cbd5e1"
            }
          }
        ]
      });

      cy.ready(() => {
        const depthMap = {};
        cy.elements().bfs({
          roots: `#p-${central.id}`,
          visit: (v, e, u, i, depth) => {
            if (v.isNode()) depthMap[v.id()] = depth;
          }
        });
        cy.nodes().forEach(node => {
          const grado = Number.isFinite(depthMap[node.id()]) ? depthMap[node.id()] : Infinity;
          node.data("grado", grado);
        });
        cy.fit();
        aplicarVista(getVistaActual());
      });

      // Panel inicial: persona central
      setPanelForPersona(central);

      // Click en nodos
      cy.on("tap", "node", evt => {
        const node = evt.target;
        const tipo = node.data("tipo");

        if (tipo === "institucion") {
          const instId = node.data("institucion_id");
          const inst = institucionesMap[instId];
          if (inst) setPanelForInstitucion(inst);
        } else {
          const personaId = node.data("persona_id");
          const persona = personasMap[personaId];
          if (persona) setPanelForPersona(persona);
        }
      });

      // Click en aristas
      cy.on("tap", "edge", evt => {
        const edge = evt.target;
        const tipo = edge.data("tipo");

        if (tipo === "cargo") {
          const rel = {
            tipo: "cargo",
            persona_id: edge.data("persona_id"),
            institucion_id: edge.data("institucion_id"),
            institucion_padre_id: edge.data("institucion_padre_id"),
            cargo_nombre: edge.data("cargo_nombre"),
            fecha_inicio: edge.data("fecha_inicio"),
            fecha_fin: edge.data("fecha_fin"),
            notas: edge.data("notas")
          };
          setPanelForRelacion(rel, personasMap, institucionesMap);
        } else {
          const rel = {
            id: edge.data("relacion_id"),
            origen: parseInt(String(edge.data("source")).replace("p-", ""), 10),
            destino: parseInt(String(edge.data("target")).replace("p-", ""), 10),
            tipo: edge.data("tipo"),
            descripcion: edge.data("descripcion"),
            fuente: edge.data("fuente")
          };
          setPanelForRelacion(rel, personasMap, institucionesMap);
        }
      });

      // Poblar chips de personas relacionadas
      const relacionadas = data.personas_conectadas || [];

      // Poblar chips de instituciones relacionadas con la persona central
      const institucionesRelacionadas = Array.from(instPadreCentral)
        .map(id => institucionesMap[id])
        .filter(Boolean);

      renderRelatedChips(relacionadas, institucionesRelacionadas);

      // Listeners de filtros
      toggleCargosEl.addEventListener("change", applyFilters);
      toggleRelacionesEl.addEventListener("change", applyFilters);
      vistaRadios.forEach(radio => radio.addEventListener("change", () => {
        aplicarVista(radio.value);
      }));

      gradoRadios.forEach(radio => radio.addEventListener("change", applyFilters));

      logDebug("Grafo dibujado.");
    })
    .catch(err => {
      console.error("Error cargando grafo:", err);
      logDebug("Error en fetch/grafo: " + err);
      mostrarErrorCarga("Ocurrió un problema al cargar el grafo.");
    });
</script>
</body>
</html>
